<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='50' x='50' text-anchor='middle' font-size='50'>üöö</text></svg>">
    <title>Elektronick√° stazka pro ≈ôidiƒçe</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
            touch-action: pan-y;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 100px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            animation: pulse 2s infinite;
        }

        .status-badge.active {
            background: rgba(76, 175, 80, 0.3);
            color: #4caf50;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .form-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            transition: all 0.3s ease;
        }

        .form-section.hidden {
            display: none;
        }

        .form-section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            opacity: 0.9;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        input[readonly] {
            opacity: 0.7;
            cursor: not-allowed;
        }

        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            box-shadow: 0 4px 15px 0 rgba(76, 175, 80, 0.4);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
            margin-bottom: 10px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            box-shadow: 0 4px 15px 0 rgba(244, 67, 54, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            box-shadow: 0 4px 15px 0 rgba(255, 152, 0, 0.4);
        }

        .map-container {
            height: 300px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .speed-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .speed-indicator.slow { color: #4caf50; }
        .speed-indicator.medium { color: #ff9800; }
        .speed-indicator.fast { color: #f44336; }

        .gps-status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-box h3 {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .stat-box p {
            font-size: 24px;
            font-weight: bold;
        }

        .stops-list {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stop-item {
            padding: 10px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 14px;
        }

        .saved-routes {
            margin-top: 30px;
        }

        .route-item {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .route-item:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.15);
        }

        .route-item.active {
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.1);
        }

        .route-item h3 {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .route-item p {
            font-size: 14px;
            opacity: 0.8;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 20px;
            max-width: 500px;
            margin: 50px auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal h2 {
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
        }

        .floating-buttons {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1500;
            max-width: 600px;
            width: calc(100% - 40px);
        }

        .floating-buttons button {
            flex: 1;
        }

        /* Animace */
        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .form-section, .route-item {
            animation: slideIn 0.5s ease-out;
        }

        /* Responzivn√≠ design */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
                padding-bottom: 100px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                üöö Elektronick√° stazka
                <span class="status-badge" id="statusBadge">Offline</span>
            </h1>
            <p id="currentDateTime"></p>
        </div>

        <!-- Formul√°≈ô pro novou cestu -->
        <div id="routeForm">
            <div class="form-section">
                <h2>üë§ √ödaje o ≈ôidiƒçi</h2>
                <div class="form-group">
                    <label for="driverName">Jm√©no a p≈ô√≠jmen√≠ <span style="color: #ff5252;">*</span></label>
                    <input type="text" id="driverName" placeholder="Jan Nov√°k" required>
                </div>
                <div class="form-group">
                    <label for="routeNumber">ƒå√≠slo stazky</label>
                    <input type="text" id="routeNumber" readonly>
                </div>
            </div>

            <div class="form-section">
                <h2>üöö √ödaje o vozidle</h2>
                <div class="form-group">
                    <label for="vehiclePlate">SPZ vozidla <span style="color: #ff5252;">*</span></label>
                    <input type="text" id="vehiclePlate" placeholder="1A2 3456" required>
                </div>
                <div class="form-group">
                    <label for="odometerStart">Stav tachometru (km) <span style="color: #ff5252;">*</span></label>
                    <input type="number" id="odometerStart" placeholder="123456" required>
                </div>
                <div class="form-group">
                    <label for="vehicleType">Typ vozidla <span style="color: #ff5252;">*</span></label>
                    <select id="vehicleType" required>
                        <option value="">Vyberte typ</option>
                        <option value="tahac">Tahaƒç</option>
                        <option value="solo">Solo vozidlo</option>
                        <option value="dodavka">Dod√°vka</option>
                        <option value="autobus">Autobus</option>
                        <option value="osobni">Osobn√≠</option>
                        <option value="ostatni">Ostatn√≠</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="trailerPlate">SPZ p≈ô√≠vƒõsu</label>
                    <input type="text" id="trailerPlate" placeholder="1A2 3457">
                </div>
            </div>

            <div class="form-section">
                <h2>üìÖ Datum a ƒças</h2>
                <div class="form-group">
                    <label for="startDate">Datum zah√°jen√≠ <span style="color: #ff5252;">*</span></label>
                    <input type="date" id="startDate" required>
                </div>
                <div class="form-group">
                    <label for="startTime">ƒåas zah√°jen√≠ <span style="color: #ff5252;">*</span></label>
                    <input type="time" id="startTime" required>
                </div>
            </div>

            <div class="form-section">
                <h2>üìç Trasa a n√°klad</h2>
                <div class="form-group">
                    <label for="startLocation">M√≠sto zah√°jen√≠ <span style="color: #ff5252;">*</span></label>
                    <div style="position: relative;">
                        <input type="text" id="startLocation" placeholder="Praha, Pr≈Ømyslov√° 1" required>
                        <button type="button" onclick="getCurrentLocation()" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); padding: 5px 10px; font-size: 12px; width: auto; background: rgba(255,255,255,0.2);">
                            üìç GPS
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="destination">C√≠l cesty <span style="color: #ff5252;">*</span></label>
                    <input type="text" id="destination" placeholder="Brno, Logistick√° 25" required>
                </div>
                <div class="form-group">
                    <label for="cargo">Popis n√°kladu</label>
                    <input type="text" id="cargo" placeholder="Paletov√Ω n√°klad, 24t">
                </div>
            </div>

            <button class="btn-primary" onclick="startRoute()">
                üöÄ Zah√°jit j√≠zdu
            </button>
        </div>

        <!-- Aktivn√≠ cesta -->
        <div id="activeRoute" style="display: none;">
            <div class="form-section">
                <h2>üó∫Ô∏è Sledov√°n√≠ trasy</h2>
                <div class="map-container">
                    <div id="map"></div>
                    <div class="speed-indicator" id="speedIndicator">0 km/h</div>
                    <div class="gps-status" id="gpsStatus">GPS: Hled√°m...</div>
                </div>
            </div>

            <div class="stats-container">
                <div class="stat-box">
                    <h3>‚è±Ô∏è Doba j√≠zdy</h3>
                    <p id="drivingTime">0:00</p>
                </div>
                <div class="stat-box">
                    <h3>üìè Vzd√°lenost</h3>
                    <p id="distance">0 km</p>
                </div>
                <div class="stat-box">
                    <h3>üõë Zast√°vky</h3>
                    <p id="stopsCount">0</p>
                </div>
                <div class="stat-box">
                    <h3>üìç GPS body</h3>
                    <p id="gpsPoints">0</p>
                </div>
            </div>

            <div class="stops-list" id="stopsList" style="display: none;">
                <h3>üìã Seznam zast√°vek</h3>
                <div id="stopsContainer"></div>
            </div>

            <div class="floating-buttons">
                <button class="btn-warning" id="stopButton" onclick="toggleStop()">
                    üõë P≈ôidat zast√°vku
                </button>
                <button class="btn-danger" onclick="showEndModal()">
                    üèÅ Ukonƒçit j√≠zdu
                </button>
            </div>
        </div>

        <!-- Seznam ulo≈æen√Ωch cest -->
        <div class="saved-routes" id="savedRoutes">
            <h2>üìÇ Ulo≈æen√© cesty</h2>
            <div id="routesList"></div>
        </div>
    </div>

    <!-- Modal pro v√Ωbƒõr akce s ulo≈æenou cestou -->
    <div class="modal" id="routeActionModal">
        <div class="modal-content">
            <h2>üìã Mo≈ænosti pro stazku <span id="modalRouteNumber"></span></h2>
            <p>Co chcete s touto stazkou udƒõlat?</p>
            <div style="margin-top: 20px;">
                <button class="btn-primary" onclick="continueRoute()" style="margin-bottom: 10px;">
                    ‚ñ∂Ô∏è Pokraƒçovat v j√≠zdƒõ
                </button>
                <button class="btn-secondary" onclick="editRoute()" style="margin-bottom: 10px;">
                    ‚úèÔ∏è Editovat √∫daje
                </button>
                <button class="btn-secondary" onclick="closeRouteActionModal()">
                    üîô Zpƒõt
                </button>
            </div>
        </div>
    </div>

    <!-- Modal pro p≈ôid√°n√≠ zast√°vky -->
    <div class="modal" id="stopModal">
        <div class="modal-content">
            <h2>üõë P≈ôidat zast√°vku</h2>
            <div class="form-group">
                <label for="stopLocation">M√≠sto zast√°vky</label>
                <input type="text" id="stopLocation" placeholder="Naƒç√≠t√°m GPS pozici...">
            </div>
            <div class="form-group">
                <label for="stopReason">D≈Øvod zast√°vky <span style="color: #ff5252;">*</span></label>
                <select id="stopReason" required>
                    <option value="">Vyberte d≈Øvod</option>
                    <option value="nakladka">Nakl√°dka</option>
                    <option value="vykladka">Vykl√°dka</option>
                    <option value="prostoj">Prostoj</option>
                    <option value="oprava">Oprava</option>
                    <option value="prestavka">P≈ôest√°vka</option>
                </select>
            </div>
            <div class="form-group">
                <label for="stopCustomer">Z√°kazn√≠k</label>
                <input type="text" id="stopCustomer" placeholder="N√°zev z√°kazn√≠ka">
            </div>
            <div class="form-group">
                <label for="stopNote">Pozn√°mka</label>
                <input type="text" id="stopNote" placeholder="Co bylo nalo≈æeno/vylo≈æeno">
            </div>
            <div class="modal-buttons">
                <button class="btn-primary" onclick="saveStop()">
                    ‚úÖ Ulo≈æit zast√°vku
                </button>
                <button class="btn-secondary" onclick="cancelStop()">
                    ‚ùå Zru≈°it
                </button>
            </div>
        </div>
    </div>
    <div class="modal" id="endModal">
        <div class="modal-content">
            <h2>üèÅ Ukonƒçen√≠ j√≠zdy</h2>
            <p>Je va≈°e aktu√°ln√≠ poloha koneƒçn√Ωm m√≠stem cesty?</p>
            <div class="modal-buttons">
                <button class="btn-primary" onclick="endRoute(true)">
                    ‚úÖ Ano, jsem v c√≠li
                </button>
                <button class="btn-secondary" onclick="showManualEndModal()">
                    ‚ùå Ne, zadat ruƒçnƒõ
                </button>
            </div>
            <button class="btn-secondary" onclick="hideEndModal()" style="margin-top: 10px;">
                üîô Zru≈°it
            </button>
        </div>
    </div>

    <!-- Modal pro ruƒçn√≠ zad√°n√≠ konce -->
    <div class="modal" id="manualEndModal">
        <div class="modal-content">
            <h2>üìç Zad√°n√≠ koncov√©ho m√≠sta</h2>
            <div class="form-group">
                <label for="manualEndLocation">M√≠sto ukonƒçen√≠</label>
                <input type="text" id="manualEndLocation" placeholder="Nap≈ô. Brno, Logistick√° 25">
            </div>
            <div class="modal-buttons">
                <button class="btn-primary" onclick="endRoute(false)">
                    ‚úÖ Potvrdit a ukonƒçit
                </button>
                <button class="btn-secondary" onclick="hideManualEndModal()">
                    üîô Zpƒõt
                </button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Glob√°ln√≠ promƒõnn√©
        let map = null;
        let currentMarker = null;
        let routeLine = null;
        let stopMarkers = [];
        let isTracking = false;
        let watchId = null;
        let routeData = null;
        let startTime = null;
        let stopStartTime = null;
        let isStopped = false;
        let autosaveInterval = null;
        let selectedRouteId = null;
        let trackingInterval = null;
        let pendingStop = null;

        // Inicializace aplikace s error handling
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
        });

        // Inicializace p≈ôi naƒçten√≠ str√°nky
        window.addEventListener('load', () => {
            initializeApp();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            loadSavedRoutes();
            setNewRouteNumber();
        });

        // Z√°kladn√≠ inicializace
        function initializeApp() {
            // Nastaven√≠ dne≈°n√≠ho data a ƒçasu
            const now = new Date();
            document.getElementById('startDate').value = now.toISOString().split('T')[0];
            document.getElementById('startTime').value = now.toTimeString().slice(0, 5);

            // P≈ôevod SPZ na velk√° p√≠smena
            document.getElementById('vehiclePlate').addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase();
            });
            document.getElementById('trailerPlate').addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase();
            });

            // Kontrola online/offline stavu
            updateOnlineStatus();
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            
            // Inicializace pr√°zdn√Ωch pol√≠ pro routeData
            if (!routeData) {
                routeData = {
                    stops: [],
                    gpsPoints: []
                };
            }
        }

        // Aktualizace data a ƒçasu
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('currentDateTime').textContent = 
                now.toLocaleDateString('cs-CZ', options);
        }

        // Kontrola online stavu
        function updateOnlineStatus() {
            const badge = document.getElementById('statusBadge');
            if (navigator.onLine) {
                badge.textContent = 'Online';
                badge.classList.add('active');
            } else {
                badge.textContent = 'Offline';
                badge.classList.remove('active');
            }
        }

        // Z√≠sk√°n√≠ aktu√°ln√≠ GPS pozice pro m√≠sto zah√°jen√≠
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert('Va≈°e za≈ô√≠zen√≠ nepodporuje GPS!');
                return;
            }

            const button = event.target;
            button.textContent = '‚è≥';
            button.disabled = true;

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Z√≠sk√°n√≠ adresy pomoc√≠ reverse geocoding
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=cs`);
                        const data = await response.json();
                        
                        let address = '';
                        if (data.address) {
                            const parts = [];
                            if (data.address.road) parts.push(data.address.road);
                            if (data.address.house_number) parts.push(data.address.house_number);
                            if (data.address.city || data.address.town || data.address.village) {
                                parts.push(data.address.city || data.address.town || data.address.village);
                            }
                            address = parts.join(', ');
                        }
                        
                        document.getElementById('startLocation').value = address || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    } catch (error) {
                        document.getElementById('startLocation').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    }
                    
                    button.textContent = 'üìç GPS';
                    button.disabled = false;
                    vibrate();
                },
                (error) => {
                    alert('Nepoda≈ôilo se z√≠skat GPS pozici!');
                    button.textContent = 'üìç GPS';
                    button.disabled = false;
                },
                { enableHighAccuracy: true }
            );
        }
        function setNewRouteNumber() {
            const routes = JSON.parse(localStorage.getItem('routes') || '[]');
            let maxNumber = 0;
            
            routes.forEach(route => {
                const match = route.routeNumber?.match(/STZ-(\d+)/);
                if (match) {
                    maxNumber = Math.max(maxNumber, parseInt(match[1]));
                }
            });
            
            const newNumber = `STZ-${String(maxNumber + 1).padStart(4, '0')}`;
            document.getElementById('routeNumber').value = newNumber;
        }

        // Zah√°jen√≠ j√≠zdy
        function startRoute() {
            // Validace formul√°≈ôe
            const required = ['driverName', 'vehiclePlate', 'odometerStart', 
                            'vehicleType', 'startLocation', 'destination'];
            
            for (let field of required) {
                if (!document.getElementById(field).value.trim()) {
                    vibrate();
                    alert('Pros√≠m vypl≈àte v≈°echna povinn√° pole!');
                    return;
                }
            }

            // Vytvo≈ôen√≠ datov√© struktury
            routeData = {
                id: Date.now(),
                routeNumber: document.getElementById('routeNumber').value,
                driver: document.getElementById('driverName').value,
                vehicle: {
                    plate: document.getElementById('vehiclePlate').value,
                    type: document.getElementById('vehicleType').value,
                    odometer: parseInt(document.getElementById('odometerStart').value),
                    trailer: document.getElementById('trailerPlate').value
                },
                startDate: document.getElementById('startDate').value,
                startTime: document.getElementById('startTime').value,
                startLocation: document.getElementById('startLocation').value,
                plannedDestination: document.getElementById('destination').value,
                cargo: document.getElementById('cargo').value,
                startTimestamp: Date.now(),
                gpsPoints: [],
                stops: [],
                status: 'active'
            };

            startTime = Date.now();
            
            // P≈ôepnut√≠ UI
            document.getElementById('routeForm').style.display = 'none';
            document.getElementById('activeRoute').style.display = 'block';
            
            // Inicializace mapy a GPS
            initializeMap();
            startGPSTracking();
            
            // Automatick√© ukl√°d√°n√≠
            autosaveInterval = setInterval(saveCurrentRoute, 30000); // ka≈æd√Ωch 30 sekund
            
            vibrate();
        }

        // Inicializace mapy
        function initializeMap() {
            if (!map) {
                map = L.map('map').setView([50.0755, 14.4378], 13);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);
            }
        }

        // GPS tracking
        function startGPSTracking() {
            if (!navigator.geolocation) {
                alert('Va≈°e za≈ô√≠zen√≠ nepodporuje GPS!');
                return;
            }

            isTracking = true;
            
            // Z√≠sk√°n√≠ prvn√≠ pozice
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    handleGPSUpdate(position);
                    // P≈ôid√°n√≠ startovn√≠ pozice do dat
                    if (routeData.gpsPoints.length === 0) {
                        routeData.startCoordinates = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                    }
                },
                handleGPSError,
                { enableHighAccuracy: true }
            );

            // Kontinu√°ln√≠ sledov√°n√≠
            watchId = navigator.geolocation.watchPosition(
                handleGPSUpdate,
                handleGPSError,
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );

            // Update ka≈æd√Ωch 5 sekund
            trackingInterval = setInterval(() => {
                if (isTracking && !isStopped) {
                    navigator.geolocation.getCurrentPosition(
                        handleGPSUpdate,
                        handleGPSError,
                        { enableHighAccuracy: true }
                    );
                }
            }, 5000);
        }

        // Zpracov√°n√≠ GPS update
        function handleGPSUpdate(position) {
            const coords = position.coords;
            const point = {
                lat: coords.latitude,
                lng: coords.longitude,
                speed: coords.speed ? Math.round(coords.speed * 3.6) : 0,
                accuracy: Math.round(coords.accuracy),
                timestamp: Date.now(),
                interpolated: false
            };

            // Kontrola interpolace
            if (routeData.gpsPoints.length > 0) {
                const lastPoint = routeData.gpsPoints[routeData.gpsPoints.length - 1];
                const distance = calculateDistance(
                    lastPoint.lat, lastPoint.lng,
                    point.lat, point.lng
                );

                // Pokud je vzd√°lenost > 1km, interpoluj body
                if (distance > 1) {
                    const interpolatedPoints = interpolatePoints(lastPoint, point, distance);
                    routeData.gpsPoints.push(...interpolatedPoints);
                }
            }

            // P≈ôidej aktu√°ln√≠ bod
            if (!isStopped) {
                routeData.gpsPoints.push(point);
            }

            // Update UI
            updateMap(point);
            updateStats();
            updateGPSStatus(coords.accuracy);
            updateSpeed(point.speed);
        }

        // Interpolace bod≈Ø
        function interpolatePoints(start, end, distance) {
            const points = [];
            const steps = Math.ceil(distance / 0.5); // bod ka≈æd√Ωch 500m
            
            for (let i = 1; i < steps; i++) {
                const ratio = i / steps;
                points.push({
                    lat: start.lat + (end.lat - start.lat) * ratio,
                    lng: start.lng + (end.lng - start.lng) * ratio,
                    speed: Math.round((start.speed + end.speed) / 2),
                    accuracy: Math.round((start.accuracy + end.accuracy) / 2),
                    timestamp: start.timestamp + (end.timestamp - start.timestamp) * ratio,
                    interpolated: true
                });
            }
            
            return points;
        }

        // Update mapy
        function updateMap(point) {
            const latLng = [point.lat, point.lng];

            // Update markeru
            if (currentMarker) {
                currentMarker.setLatLng(latLng);
            } else {
                currentMarker = L.marker(latLng, {
                    icon: L.divIcon({
                        html: '<div style="background: #2196f3; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white;"></div>',
                        iconSize: [20, 20],
                        className: 'current-position-marker'
                    })
                }).addTo(map);
            }

            // Kruh p≈ôesnosti
            if (currentMarker.accuracyCircle) {
                map.removeLayer(currentMarker.accuracyCircle);
            }
            currentMarker.accuracyCircle = L.circle(latLng, {
                radius: point.accuracy,
                color: '#2196f3',
                fillColor: '#2196f3',
                fillOpacity: 0.2,
                weight: 1
            }).addTo(map);

            // Update trasy
            if (routeData.gpsPoints.length > 1) {
                const routeCoords = routeData.gpsPoints.map(p => [p.lat, p.lng]);
                
                if (routeLine) {
                    routeLine.setLatLngs(routeCoords);
                } else {
                    routeLine = L.polyline(routeCoords, {
                        color: '#f44336',
                        weight: 4,
                        opacity: 0.8,
                        smoothFactor: 1
                    }).addTo(map);
                }
            }

            // Centrovat mapu
            map.setView(latLng, map.getZoom());
        }

        // Update statistik
        function updateStats() {
            // Doba j√≠zdy
            const elapsed = Date.now() - startTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            document.getElementById('drivingTime').textContent = 
                `${hours}:${minutes.toString().padStart(2, '0')}`;

            // Vzd√°lenost
            let totalDistance = 0;
            for (let i = 1; i < routeData.gpsPoints.length; i++) {
                totalDistance += calculateDistance(
                    routeData.gpsPoints[i-1].lat,
                    routeData.gpsPoints[i-1].lng,
                    routeData.gpsPoints[i].lat,
                    routeData.gpsPoints[i].lng
                );
            }
            document.getElementById('distance').textContent = 
                `${totalDistance.toFixed(1)} km`;

            // Poƒçet bod≈Ø a zast√°vek
            document.getElementById('gpsPoints').textContent = routeData.gpsPoints.length;
            document.getElementById('stopsCount').textContent = routeData.stops.length;
        }

        // Update GPS statusu
        function updateGPSStatus(accuracy) {
            const status = document.getElementById('gpsStatus');
            if (accuracy < 10) {
                status.textContent = `GPS: V√Ωborn√° (¬±${accuracy}m)`;
                status.style.color = '#4caf50';
            } else if (accuracy < 30) {
                status.textContent = `GPS: Dobr√° (¬±${accuracy}m)`;
                status.style.color = '#ff9800';
            } else {
                status.textContent = `GPS: Slab√° (¬±${accuracy}m)`;
                status.style.color = '#f44336';
            }
        }

        // Update rychlosti
        function updateSpeed(speed) {
            const indicator = document.getElementById('speedIndicator');
            indicator.textContent = `${speed} km/h`;
            
            indicator.className = 'speed-indicator';
            if (speed < 50) {
                indicator.classList.add('slow');
            } else if (speed < 80) {
                indicator.classList.add('medium');
            } else {
                indicator.classList.add('fast');
            }
        }

        // GPS chyba
        function handleGPSError(error) {
            console.error('GPS Error:', error);
            document.getElementById('gpsStatus').textContent = 'GPS: Nedostupn√°';
        }

        // P≈ôid√°n√≠/ukonƒçen√≠ zast√°vky
        function toggleStop() {
            const button = document.getElementById('stopButton');
            
            if (!isStopped) {
                // Zobraz modal pro p≈ôid√°n√≠ zast√°vky
                document.getElementById('stopModal').style.display = 'block';
                document.getElementById('stopLocation').value = 'Z√≠sk√°v√°m GPS pozici...';
                document.getElementById('stopReason').value = '';
                document.getElementById('stopCustomer').value = '';
                document.getElementById('stopNote').value = '';
                
                // Z√≠skej GPS pozici a adresu
                navigator.geolocation.getCurrentPosition(async (position) => {
                    pendingStop = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // Z√≠sk√°n√≠ adresy
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}&accept-language=cs`);
                        const data = await response.json();
                        
                        let address = '';
                        if (data.address) {
                            const parts = [];
                            if (data.address.road) parts.push(data.address.road);
                            if (data.address.house_number) parts.push(data.address.house_number);
                            if (data.address.city || data.address.town || data.address.village) {
                                parts.push(data.address.city || data.address.town || data.address.village);
                            }
                            address = parts.join(', ');
                        }
                        
                        document.getElementById('stopLocation').value = address || `${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`;
                    } catch (error) {
                        document.getElementById('stopLocation').value = `${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`;
                    }
                }, (error) => {
                    console.error('GPS Error:', error);
                    document.getElementById('stopLocation').value = '';
                    alert('Nepoda≈ôilo se z√≠skat GPS pozici. Zadejte m√≠sto ruƒçnƒõ.');
                });
            } else {
                // Ukonƒçen√≠ zast√°vky
                const lastStop = routeData.stops[routeData.stops.length - 1];
                lastStop.endTime = Date.now();
                lastStop.duration = lastStop.endTime - lastStop.startTime;
                
                isStopped = false;
                button.textContent = 'üõë P≈ôidat zast√°vku';
                button.classList.remove('btn-primary');
                button.classList.add('btn-warning');
                
                updateStopsList();
                updateStats();
                vibrate();
            }
        }

        // Ulo≈æen√≠ zast√°vky
        function saveStop() {
            const location = document.getElementById('stopLocation').value.trim();
            const reason = document.getElementById('stopReason').value;
            const customer = document.getElementById('stopCustomer').value.trim();
            const note = document.getElementById('stopNote').value.trim();
            
            if (!location || !reason) {
                alert('Vypl≈àte m√≠sto a d≈Øvod zast√°vky!');
                return;
            }
            
            const stop = {
                id: Date.now(),
                startTime: Date.now(),
                lat: pendingStop?.lat || 0,
                lng: pendingStop?.lng || 0,
                address: location,
                reason: reason,
                customer: customer,
                note: note
            };
            
            routeData.stops.push(stop);
            stopStartTime = Date.now();
            isStopped = true;
            
            const button = document.getElementById('stopButton');
            button.textContent = '‚ñ∂Ô∏è Pokraƒçovat v j√≠zdƒõ';
            button.classList.remove('btn-warning');
            button.classList.add('btn-primary');
            
            // P≈ôidej marker na mapu
            const marker = L.marker([stop.lat, stop.lng], {
                icon: L.divIcon({
                    html: `<div style="background: #ff9800; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">${routeData.stops.length}</div>`,
                    iconSize: [30, 30],
                    className: 'stop-marker'
                })
            }).addTo(map);
            
            const reasonText = {
                'nakladka': 'Nakl√°dka',
                'vykladka': 'Vykl√°dka',
                'prostoj': 'Prostoj',
                'oprava': 'Oprava',
                'prestavka': 'P≈ôest√°vka'
            }[reason] || reason;
            
            marker.bindPopup(`<b>Zast√°vka ${routeData.stops.length}</b><br>${reasonText}<br>${location}`);
            stopMarkers.push(marker);
            
            // Skryj modal
            document.getElementById('stopModal').style.display = 'none';
            pendingStop = null;
            
            updateStopsList();
            updateStats();
            vibrate();
        }

        // Zru≈°en√≠ p≈ôid√°n√≠ zast√°vky
        function cancelStop() {
            document.getElementById('stopModal').style.display = 'none';
            pendingStop = null;
        }

        // Update seznamu zast√°vek
        function updateStopsList() {
            const container = document.getElementById('stopsContainer');
            const list = document.getElementById('stopsList');
            
            if (routeData.stops.length === 0) {
                list.style.display = 'none';
                return;
            }
            
            list.style.display = 'block';
            container.innerHTML = '';
            
            routeData.stops.forEach((stop, index) => {
                const duration = stop.duration ? 
                    `${Math.floor(stop.duration / 60000)} min` : 
                    'Prob√≠h√°...';
                
                const reasonText = {
                    'nakladka': 'Nakl√°dka',
                    'vykladka': 'Vykl√°dka',
                    'prostoj': 'Prostoj',
                    'oprava': 'Oprava',
                    'prestavka': 'P≈ôest√°vka'
                }[stop.reason] || stop.reason || '';
                    
                const div = document.createElement('div');
                div.className = 'stop-item';
                div.innerHTML = `
                    <strong>Zast√°vka ${index + 1} - ${reasonText}</strong><br>
                    üìç ${stop.address}<br>
                    ${stop.customer ? `üë§ ${stop.customer}<br>` : ''}
                    ${stop.note ? `üìù ${stop.note}<br>` : ''}
                    ‚è±Ô∏è Doba: ${duration}
                `;
                container.appendChild(div);
            });
        }

        // Zobrazen√≠ modalu pro ukonƒçen√≠
        function showEndModal() {
            document.getElementById('endModal').style.display = 'block';
            vibrate();
        }

        function hideEndModal() {
            document.getElementById('endModal').style.display = 'none';
        }

        function showManualEndModal() {
            document.getElementById('endModal').style.display = 'none';
            document.getElementById('manualEndModal').style.display = 'block';
            document.getElementById('manualEndLocation').value = routeData.plannedDestination;
        }

        function hideManualEndModal() {
            document.getElementById('manualEndModal').style.display = 'none';
            document.getElementById('endModal').style.display = 'block';
        }

        // Ukonƒçen√≠ cesty
        function endRoute(useCurrentLocation) {
            // Z√≠sk√°n√≠ koncov√© pozice
            if (useCurrentLocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    routeData.endCoordinates = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    routeData.actualDestination = 'Aktu√°ln√≠ poloha';
                    routeData.endType = 'automatic';
                    finalizeRoute();
                }, (error) => {
                    console.error('GPS Error:', error);
                    alert('Nepoda≈ôilo se z√≠skat GPS pozici. Pou≈æiji posledn√≠ zn√°mou polohu.');
                    if (routeData.gpsPoints.length > 0) {
                        const lastPoint = routeData.gpsPoints[routeData.gpsPoints.length - 1];
                        routeData.endCoordinates = {
                            lat: lastPoint.lat,
                            lng: lastPoint.lng
                        };
                        routeData.actualDestination = 'Posledn√≠ zn√°m√° poloha';
                        routeData.endType = 'automatic';
                        finalizeRoute();
                    }
                });
            } else {
                const manualLocation = document.getElementById('manualEndLocation').value.trim();
                if (!manualLocation) {
                    alert('Pros√≠m zadejte koncov√© m√≠sto!');
                    return;
                }
                routeData.actualDestination = manualLocation;
                routeData.endType = 'manual';
                // Pou≈æij posledn√≠ zn√°mou pozici
                if (routeData.gpsPoints.length > 0) {
                    const lastPoint = routeData.gpsPoints[routeData.gpsPoints.length - 1];
                    routeData.endCoordinates = {
                        lat: lastPoint.lat,
                        lng: lastPoint.lng
                    };
                }
                finalizeRoute();
            }
        }

        function finalizeRoute() {
            // Zastaven√≠ trackingu
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
            if (trackingInterval) {
                clearInterval(trackingInterval);
            }
            clearInterval(autosaveInterval);
            isTracking = false;

            // Fin√°ln√≠ data
            routeData.endTimestamp = Date.now();
            routeData.status = 'completed';
            routeData.totalDuration = routeData.endTimestamp - routeData.startTimestamp;
            
            // V√Ωpoƒçet statistik
            let totalDistance = 0;
            let maxSpeed = 0;
            let speedSum = 0;
            let speedCount = 0;
            
            for (let i = 1; i < routeData.gpsPoints.length; i++) {
                totalDistance += calculateDistance(
                    routeData.gpsPoints[i-1].lat,
                    routeData.gpsPoints[i-1].lng,
                    routeData.gpsPoints[i].lat,
                    routeData.gpsPoints[i].lng
                );
                
                if (routeData.gpsPoints[i].speed > 0) {
                    maxSpeed = Math.max(maxSpeed, routeData.gpsPoints[i].speed);
                    speedSum += routeData.gpsPoints[i].speed;
                    speedCount++;
                }
            }
            
            routeData.statistics = {
                totalDistance: totalDistance.toFixed(2),
                totalDuration: formatDuration(routeData.totalDuration),
                averageSpeed: speedCount > 0 ? (speedSum / speedCount).toFixed(1) : 0,
                maxSpeed: maxSpeed,
                totalStops: routeData.stops.length,
                totalGPSPoints: routeData.gpsPoints.length,
                interpolatedPoints: routeData.gpsPoints.filter(p => p.interpolated).length
            };

            // Skryj modaly
            document.getElementById('endModal').style.display = 'none';
            document.getElementById('manualEndModal').style.display = 'none';

        // Zobrazen√≠ souhrnu cesty
        function showSummary() {
            const modal = document.getElementById('summaryModal');
            const content = document.getElementById('summaryContent');
            
            // Vytvo≈ô souhrn
            content.innerHTML = `
                <div class="form-section" style="background: rgba(76, 175, 80, 0.1);">
                    <h3>üìã ${routeData.routeNumber}</h3>
                    <p><strong>≈òidiƒç:</strong> ${routeData.driver}</p>
                    <p><strong>Vozidlo:</strong> ${routeData.vehicle.plate} (${routeData.vehicle.type})</p>
                    <p><strong>Trasa:</strong> ${routeData.startLocation} ‚Üí ${routeData.actualDestination}</p>
                    <p><strong>Vzd√°lenost:</strong> ${routeData.statistics.totalDistance} km</p>
                    <p><strong>Doba j√≠zdy:</strong> ${routeData.statistics.totalDuration}</p>
                    <p><strong>Pr≈Ømƒõrn√° rychlost:</strong> ${routeData.statistics.averageSpeed} km/h</p>
                    <p><strong>Poƒçet zast√°vek:</strong> ${routeData.statistics.totalStops}</p>
                    <p><strong>GPS bod≈Ø:</strong> ${routeData.statistics.totalGPSPoints}</p>
                </div>
            `;
            
            modal.style.display = 'block';
            
            // Inicializuj mapu se souhrnem
            setTimeout(() => {
                const summaryMap = L.map('summaryMap').setView([50.0755, 14.4378], 13);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(summaryMap);
                
                // Zobraz celou trasu
                if (routeData.gpsPoints.length > 0) {
                    const routeCoords = routeData.gpsPoints.map(p => [p.lat, p.lng]);
                    const summaryLine = L.polyline(routeCoords, {
                        color: '#f44336',
                        weight: 4,
                        opacity: 0.8
                    }).addTo(summaryMap);
                    
                    // Start marker
                    L.marker([routeData.startCoordinates.lat, routeData.startCoordinates.lng], {
                        icon: L.divIcon({
                            html: '<div style="background: #4caf50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">S</div>',
                            iconSize: [30, 30]
                        })
                    }).addTo(summaryMap).bindPopup('Start: ' + routeData.startLocation);
                    
                    // End marker
                    if (routeData.endCoordinates) {
                        L.marker([routeData.endCoordinates.lat, routeData.endCoordinates.lng], {
                            icon: L.divIcon({
                                html: '<div style="background: #f44336; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">C</div>',
                                iconSize: [30, 30]
                            })
                        }).addTo(summaryMap).bindPopup('C√≠l: ' + routeData.actualDestination);
                    }
                    
                    // Zast√°vky
                    routeData.stops.forEach((stop, index) => {
                        L.marker([stop.lat, stop.lng], {
                            icon: L.divIcon({
                                html: `<div style="background: #ff9800; color: white; width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px;">${index + 1}</div>`,
                                iconSize: [25, 25]
                            })
                        }).addTo(summaryMap).bindPopup(`Zast√°vka ${index + 1}: ${stop.reason}`);
                    });
                    
                    // Fit bounds
                    summaryMap.fitBounds(summaryLine.getBounds());
                }
            }, 300);
        }

        function sendSummary() {
            generateAndSendXML();
        }

        function closeSummary() {
            document.getElementById('summaryModal').style.display = 'none';
            setTimeout(() => {
                location.reload();
            }, 500);
        }
        }

        // Generov√°n√≠ XML
        function generateAndSendXML() {
            const xml = generateXML(routeData);
            
            // Vytvo≈ôen√≠ emailu
            const subject = `Elektronick√° stazka ${routeData.routeNumber} - ${routeData.driver}`;
            const body = `Dobr√Ω den,\n\nv p≈ô√≠loze zas√≠l√°m elektronickou stazku.\n\nƒå√≠slo: ${routeData.routeNumber}\n≈òidiƒç: ${routeData.driver}\nVozidlo: ${routeData.vehicle.plate}\nTrasa: ${routeData.startLocation} ‚Üí ${routeData.actualDestination}\nVzd√°lenost: ${routeData.statistics.totalDistance} km\nDoba j√≠zdy: ${routeData.statistics.totalDuration}\n\nXML data jsou n√≠≈æe:\n\n${xml}`;
            
            // Otev≈ôen√≠ emailov√©ho klienta
            const mailtoLink = `mailto:zsiska@seznam.cz?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Pokus o otev≈ôen√≠
            window.location.href = mailtoLink;
            
            // Z√°lo≈æn√≠ ≈ôe≈°en√≠ - zobrazen√≠ v konzoli
            console.log('=== XML DATA ===');
            console.log(xml);
            console.log('================');
            
            alert('Elektronick√° stazka byla ukonƒçena a p≈ôipravena k odesl√°n√≠!');
        }

        function generateXML(data) {
            const xml = `<?xml version="1.0" encoding="UTF-8"?>
<elektronicka_stazka>
    <cislo_stazky>${data.routeNumber}</cislo_stazky>
    <ridic>
        <jmeno>${escapeXML(data.driver)}</jmeno>
    </ridic>
    <vozidlo>
        <spz>${data.vehicle.plate}</spz>
        <typ>${data.vehicle.type}</typ>
        <tachometr_start>${data.vehicle.odometer}</tachometr_start>
        <prives_spz>${data.vehicle.trailer || 'N/A'}</prives_spz>
    </vozidlo>
    <jizda>
        <datum_zahajeni>${data.startDate}</datum_zahajeni>
        <cas_zahajeni>${data.startTime}</cas_zahajeni>
        <misto_zahajeni>${escapeXML(data.startLocation)}</misto_zahajeni>
        <planovany_cil>${escapeXML(data.plannedDestination)}</planovany_cil>
        <skutecny_cil>${escapeXML(data.actualDestination)}</skutecny_cil>
        <typ_ukonceni>${data.endType}</typ_ukonceni>
        <naklad>${escapeXML(data.cargo || 'N/A')}</naklad>
    </jizda>
    <statistiky>
        <celkova_vzdalenost_km>${data.statistics.totalDistance}</celkova_vzdalenost_km>
        <doba_jizdy>${data.statistics.totalDuration}</doba_jizdy>
        <prumerna_rychlost_kmh>${data.statistics.averageSpeed}</prumerna_rychlost_kmh>
        <maximalni_rychlost_kmh>${data.statistics.maxSpeed}</maximalni_rychlost_kmh>
        <pocet_zastavek>${data.statistics.totalStops}</pocet_zastavek>
        <pocet_gps_bodu>${data.statistics.totalGPSPoints}</pocet_gps_bodu>
        <pocet_interpolovanych_bodu>${data.statistics.interpolatedPoints}</pocet_interpolovanych_bodu>
    </statistiky>
    <gps_souradnice>
        <start>
            <lat>${data.startCoordinates?.lat || 'N/A'}</lat>
            <lng>${data.startCoordinates?.lng || 'N/A'}</lng>
        </start>
        <konec>
            <lat>${data.endCoordinates?.lat || 'N/A'}</lat>
            <lng>${data.endCoordinates?.lng || 'N/A'}</lng>
        </konec>
    </gps_souradnice>
    <zastavky>
        ${data.stops.map((stop, index) => `
        <zastavka cislo="${index + 1}">
            <cas_zahajeni>${new Date(stop.startTime).toISOString()}</cas_zahajeni>
            <cas_ukonceni>${stop.endTime ? new Date(stop.endTime).toISOString() : 'N/A'}</cas_ukonceni>
            <doba_trvani_min>${stop.duration ? Math.floor(stop.duration / 60000) : 'N/A'}</doba_trvani_min>
            <souradnice>
                <lat>${stop.lat}</lat>
                <lng>${stop.lng}</lng>
            </souradnice>
            <adresa>${escapeXML(stop.address)}</adresa>
            <duvod>${escapeXML(stop.reason || 'N/A')}</duvod>
            <zakaznik>${escapeXML(stop.customer || 'N/A')}</zakaznik>
            <poznamka>${escapeXML(stop.note || 'N/A')}</poznamka>
        </zastavka>`).join('')}
    </zastavky>
    <trasa>
        <pocet_bodu>${data.gpsPoints.length}</pocet_bodu>
        <body>
        ${data.gpsPoints.map((point, index) => `
            <bod cislo="${index + 1}" interpolovany="${point.interpolated}">
                <cas>${new Date(point.timestamp).toISOString()}</cas>
                <lat>${point.lat.toFixed(6)}</lat>
                <lng>${point.lng.toFixed(6)}</lng>
                <rychlost_kmh>${point.speed}</rychlost_kmh>
                <presnost_m>${point.accuracy}</presnost_m>
            </bod>`).join('')}
        </body>
    </trasa>
</elektronicka_stazka>`;
            return xml;
        }

        function escapeXML(str) {
            if (!str) return '';
            return str.toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }

        // Ukl√°d√°n√≠ a naƒç√≠t√°n√≠ cest
        function saveRoute() {
            const routes = JSON.parse(localStorage.getItem('routes') || '[]');
            const existingIndex = routes.findIndex(r => r.id === routeData.id);
            
            if (existingIndex >= 0) {
                routes[existingIndex] = routeData;
            } else {
                routes.push(routeData);
            }
            
            localStorage.setItem('routes', JSON.stringify(routes));
        }

        function saveCurrentRoute() {
            if (routeData) {
                saveRoute();
            }
        }

        function loadSavedRoutes() {
            const routes = JSON.parse(localStorage.getItem('routes') || '[]');
            const container = document.getElementById('routesList');
            
            if (routes.length === 0) {
                container.innerHTML = '<p style="opacity: 0.7;">≈Ω√°dn√© ulo≈æen√© cesty</p>';
                return;
            }
            
            container.innerHTML = '';
            routes.reverse().forEach(route => {
                const div = document.createElement('div');
                div.className = 'route-item';
                if (route.status === 'active') {
                    div.classList.add('active');
                }
                
                const date = new Date(route.startTimestamp);
                const dateStr = date.toLocaleDateString('cs-CZ');
                const timeStr = date.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
                
                div.innerHTML = `
                    <h3>${route.routeNumber} - ${route.driver}</h3>
                    <p>üìÖ ${dateStr} ${timeStr}</p>
                    <p>üöö ${route.vehicle.plate}</p>
                    <p>üìç ${route.startLocation} ‚Üí ${route.actualDestination || route.plannedDestination}</p>
                    <p>üìä Status: ${route.status === 'active' ? 'üü¢ Aktivn√≠' : '‚úÖ Dokonƒçeno'}</p>
                `;
                
                div.onclick = () => showRouteActionModal(route.id);
                div.style.cursor = 'pointer';
                
                container.appendChild(div);
            });
        }

        // Modal pro v√Ωbƒõr akce s cestou
        function showRouteActionModal(routeId) {
            selectedRouteId = routeId;
            const routes = JSON.parse(localStorage.getItem('routes') || '[]');
            const route = routes.find(r => r.id === routeId);
            
            if (!route) return;
            
            document.getElementById('modalRouteNumber').textContent = route.routeNumber;
            document.getElementById('routeActionModal').style.display = 'block';
            vibrate();
        }

        function closeRouteActionModal() {
            document.getElementById('routeActionModal').style.display = 'none';
            selectedRouteId = null;
        }

        function editRoute() {
            const routes = JSON.parse(localStorage.getItem('routes') || '[]');
            const route = routes.find(r => r.id === selectedRouteId);
            
            if (!route) return;
            
            // Naƒçti data do formul√°≈ôe
            document.getElementById('driverName').value = route.driver;
            document.getElementById('routeNumber').value = route.routeNumber;
            document.getElementById('vehiclePlate').value = route.vehicle.plate;
            document.getElementById('odometerStart').value = route.vehicle.odometer;
            document.getElementById('vehicleType').value = route.vehicle.type;
            document.getElementById('trailerPlate').value = route.vehicle.trailer || '';
            document.getElementById('startDate').value = route.startDate;
            document.getElementById('startTime').value = route.startTime;
            document.getElementById('startLocation').value = route.startLocation;
            document.getElementById('destination').value = route.plannedDestination;
            document.getElementById('cargo').value = route.cargo || '';
            
            closeRouteActionModal();
            
            // Umo≈æni editaci a ulo≈æen√≠
            const startButton = document.querySelector('.btn-primary');
            startButton.textContent = 'üíæ Ulo≈æit zmƒõny';
            startButton.onclick = () => {
                // Aktualizuj data
                route.driver = document.getElementById('driverName').value;
                route.vehicle.plate = document.getElementById('vehiclePlate').value;
                route.vehicle.odometer = parseInt(document.getElementById('odometerStart').value);
                route.vehicle.type = document.getElementById('vehicleType').value;
                route.vehicle.trailer = document.getElementById('trailerPlate').value;
                route.startLocation = document.getElementById('startLocation').value;
                route.plannedDestination = document.getElementById('destination').value;
                route.cargo = document.getElementById('cargo').value;
                
                // Ulo≈æ
                const index = routes.findIndex(r => r.id === selectedRouteId);
                if (index >= 0) {
                    routes[index] = route;
                    localStorage.setItem('routes', JSON.stringify(routes));
                }
                
                alert('Zmƒõny byly ulo≈æeny!');
                location.reload();
            };
        }

        function continueRoute(routeIdParam) {
            const routeId = routeIdParam || selectedRouteId;
            const routes = JSON.parse(localStorage.getItem('routes') || '[]');
            const route = routes.find(r => r.id === routeId);
            
            if (!route) {
                alert('Cesta nenalezena!');
                return;
            }
            
            closeRouteActionModal();
            
            // Naƒçten√≠ dat
            routeData = route;
            startTime = route.startTimestamp;
            
            // P≈ôepnut√≠ UI
            document.getElementById('routeForm').style.display = 'none';
            document.getElementById('activeRoute').style.display = 'block';
            
            // Inicializace mapy a zobrazen√≠ existuj√≠c√≠ trasy
            initializeMap();
            
            // Zobraz existuj√≠c√≠ trasu
            if (routeData.gpsPoints.length > 0) {
                const routeCoords = routeData.gpsPoints.map(p => [p.lat, p.lng]);
                routeLine = L.polyline(routeCoords, {
                    color: '#f44336',
                    weight: 4,
                    opacity: 0.8
                }).addTo(map);
                
                // Zobraz zast√°vky
                routeData.stops.forEach((stop, index) => {
                    const marker = L.marker([stop.lat, stop.lng], {
                        icon: L.divIcon({
                            html: `<div style="background: #ff9800; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">${index + 1}</div>`,
                            iconSize: [30, 30],
                            className: 'stop-marker'
                        })
                    }).addTo(map);
                    
                    marker.bindPopup(`Zast√°vka ${index + 1}`);
                    stopMarkers.push(marker);
                });
                
                // Nastav pohled na celou trasu
                map.fitBounds(routeLine.getBounds());
                
                // Kontrola vzd√°lenosti od posledn√≠ pozice
                navigator.geolocation.getCurrentPosition((position) => {
                    const lastPoint = routeData.gpsPoints[routeData.gpsPoints.length - 1];
                    const distance = calculateDistance(
                        lastPoint.lat, lastPoint.lng,
                        position.coords.latitude, position.coords.longitude
                    );
                    
                    if (distance > 1) {
                        if (confirm(`Nach√°z√≠te se ${distance.toFixed(1)} km od posledn√≠ho bodu. Chcete automaticky doplnit trasu?`)) {
                            const currentPoint = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                speed: 0,
                                accuracy: position.coords.accuracy,
                                timestamp: Date.now(),
                                interpolated: false
                            };
                            
                            const interpolatedPoints = interpolatePoints(lastPoint, currentPoint, distance);
                            routeData.gpsPoints.push(...interpolatedPoints);
                            routeData.gpsPoints.push(currentPoint);
                            
                            // Aktualizuj trasu na mapƒõ
                            const newCoords = routeData.gpsPoints.map(p => [p.lat, p.lng]);
                            routeLine.setLatLngs(newCoords);
                        }
                    }
                });
            }
            
            // Pokraƒçuj v trackingu
            startGPSTracking();
            updateStats();
            updateStopsList();
            
            // Obnov automatick√© ukl√°d√°n√≠
            autosaveInterval = setInterval(saveCurrentRoute, 30000);
            
            vibrate();
            
            // Zmƒõ≈à status na aktivn√≠ pokud byla dokonƒçen√°
            if (route.status === 'completed') {
                routeData.status = 'active';
                routeData.endTimestamp = null;
                routeData.actualDestination = null;
                routeData.endCoordinates = null;
                routeData.endType = null;
                routeData.statistics = null;
                saveCurrentRoute();
            }
            
            alert('Pokraƒçov√°n√≠ v cestƒõ zah√°jeno!');
        }

        // Pomocn√© funkce
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius Zemƒõ v km
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function toRad(deg) {
            return deg * (Math.PI/180);
        }

        function formatDuration(ms) {
            const hours = Math.floor(ms / 3600000);
            const minutes = Math.floor((ms % 3600000) / 60000);
            return `${hours}h ${minutes}min`;
        }

        function vibrate() {
            if ('vibrate' in navigator) {
                navigator.vibrate(50);
            }
        }

        // Ulo≈æen√≠ p≈ôi zav≈ôen√≠ str√°nky
        window.addEventListener('beforeunload', () => {
            if (routeData && routeData.status === 'active') {
                saveCurrentRoute();
            }
        });
    </script>
</body>
</html>
