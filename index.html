<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Elektronick√° stazka</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * {margin:0;padding:0;box-sizing:border-box}
    body {font-family:system-ui,-apple-system,sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh;display:flex;flex-direction:column}
    
    .header {padding:1rem;background:#1e293b;border-bottom:1px solid #334155}
    .header-top {display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem}
    .brand {font-size:1.2rem;font-weight:bold}
    .status {display:flex;gap:1rem;font-size:0.9rem;color:#94a3b8}
    .dot {width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:0.3rem}
    .dot.green {background:#22c55e}
    .dot.yellow {background:#f59e0b}
    .dot.red {background:#ef4444}
    
    .steps {display:flex;gap:0.5rem;flex-wrap:wrap}
    .step {padding:0.3rem 0.6rem;border:1px solid #334155;border-radius:20px;font-size:0.85rem;color:#94a3b8}
    .step.active {background:#3b82f6;color:white;border-color:#3b82f6}
    .step.done {background:#22c55e;color:white;border-color:#22c55e}
    
    .main {flex:1;display:flex;gap:1rem;padding:1rem}
    .left-panel {flex:1;display:flex;flex-direction:column;gap:1rem}
    .right-panel {width:400px;display:flex;flex-direction:column;gap:1rem}
    
    .card {background:#1e293b;border:1px solid #334155;border-radius:8px;padding:1rem}
    .card h2 {font-size:1.1rem;margin-bottom:0.5rem}
    
    .map-container {height:300px;background:#0f172a;border-radius:8px;position:relative;overflow:hidden}
    #leaflet-map {height:100%;width:100%;border-radius:8px}
    .vehicle-icon {position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:24px;z-index:10}
    .route-dot {position:absolute;width:4px;height:4px;background:#3b82f6;border-radius:50%;opacity:0.7}
    
    .kpis {display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem;margin-top:0.5rem}
    .kpi {background:#0f172a;padding:0.5rem;border-radius:6px;text-align:center}
    .kpi-value {font-size:1.5rem;font-weight:bold}
    .kpi-label {font-size:0.75rem;color:#94a3b8}
    
    .form-row {margin-bottom:0.75rem}
    .form-row label {display:block;font-size:0.85rem;color:#94a3b8;margin-bottom:0.25rem}
    .form-row input, .form-row select {width:100%;padding:0.5rem;background:#0f172a;border:1px solid #334155;border-radius:6px;color:#e2e8f0}
    
    .buttons {display:flex;gap:0.5rem;margin-top:1rem;flex-wrap:wrap}
    .btn {padding:0.5rem 1rem;border:none;border-radius:6px;cursor:pointer;font-weight:500}
    .btn-primary {background:#3b82f6;color:white}
    .btn-secondary {background:#475569;color:white}
    .btn-success {background:#22c55e;color:white}
    .btn-danger {background:#ef4444;color:white}
    .btn-warning {background:#f59e0b;color:white}
    .btn:disabled {opacity:0.5;cursor:not-allowed}
    
    .screen {display:none}
    .screen.active {display:block}
    
    .mode-buttons {display:grid;grid-template-columns:repeat(2,1fr);gap:0.5rem}
    .mode-btn {padding:0.75rem;border:1px solid #334155;background:#0f172a;color:#e2e8f0;border-radius:6px;cursor:pointer}
    .mode-btn.active {background:#3b82f6;border-color:#3b82f6}
    
    .info-text {color:#94a3b8;font-size:0.9rem;margin:0.5rem 0}
    
    /* Modal styles */
    .modal {display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:100}
    .modal.active {display:flex;align-items:center;justify-content:center}
    .modal-content {background:#1e293b;border-radius:8px;padding:1.5rem;max-width:600px;max-height:80vh;overflow-y:auto;width:90%}
    .modal-header {display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
    .modal-header h2 {margin:0}
    .close-btn {background:transparent;border:none;color:#ef4444;font-size:1.5rem;cursor:pointer}
    
    /* Stop detection modal */
    .stop-modal {background:#1e293b;border:2px solid #f59e0b;box-shadow:0 0 20px rgba(245,158,11,0.3)}
    .stop-buttons {display:grid;grid-template-columns:repeat(2,1fr);gap:0.5rem;margin-top:1rem}
    .stop-btn {padding:1rem;border:1px solid #334155;background:#0f172a;color:#e2e8f0;border-radius:6px;cursor:pointer;font-size:1rem;transition:all 0.2s}
    .stop-btn:hover {background:#3b82f6;border-color:#3b82f6}
    
    /* Loading/Unloading details modal */
    .cargo-modal {background:#1e293b;border:2px solid #3b82f6}
    .unit-selector {display:flex;gap:0.3rem;flex-wrap:wrap;margin-top:0.5rem}
    .unit-btn {padding:0.3rem 0.6rem;border:1px solid #334155;background:#0f172a;color:#94a3b8;border-radius:4px;cursor:pointer;font-size:0.85rem}
    .unit-btn.active {background:#3b82f6;color:white;border-color:#3b82f6}
    
    /* Trip list styles */
    .trip-list {max-height:400px;overflow-y:auto}
    .trip-item {background:#0f172a;border:1px solid #334155;border-radius:6px;padding:1rem;margin-bottom:0.5rem}
    .trip-header {display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem}
    .trip-title {font-weight:bold}
    .trip-status {padding:0.2rem 0.5rem;border-radius:4px;font-size:0.75rem}
    .trip-status.active {background:#22c55e;color:white}
    .trip-status.completed {background:#3b82f6;color:white}
    .trip-details {font-size:0.85rem;color:#94a3b8;line-height:1.4}
    .trip-actions {display:flex;gap:0.5rem;margin-top:0.5rem}
    
    @media (max-width: 768px) {
      .main {flex-direction:column}
      .right-panel {width:100%}
      .kpis {grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-top">
      <div class="brand">üìç Elektronick√° stazka</div>
      <div class="status">
        <span><span class="dot green"></span>Online</span>
        <span><span class="dot" id="gps-status-dot"></span><span id="gps-status">GPS ƒçek√°</span></span>
        <span id="time">--:--:--</span>
      </div>
    </div>
    <div class="steps">
      <div class="step active" id="step-1">1. √övod</div>
      <div class="step" id="step-2">2. ≈òidiƒç</div>
      <div class="step" id="step-3">3. Start</div>
      <div class="step" id="step-4">4. J√≠zda</div>
      <div class="step" id="step-5">5. Konec</div>
      <div class="step" id="step-6">6. Sum√°≈ô</div>
    </div>
  </div>

  <div class="main">
    <div class="left-panel">
      <div class="card">
        <h2>Mapa a trasa</h2>
        <div class="map-container">
          <div id="leaflet-map"></div>
        </div>
        <div class="kpis">
          <div class="kpi">
            <div class="kpi-value" id="speed">0</div>
            <div class="kpi-label">km/h</div>
          </div>
          <div class="kpi">
            <div class="kpi-value" id="distance">0.0</div>
            <div class="kpi-label">km</div>
          </div>
          <div class="kpi">
            <div class="kpi-value" id="odometer">0</div>
            <div class="kpi-label">tachometr</div>
          </div>
          <div class="kpi">
            <div class="kpi-value" id="duration">0:00</div>
            <div class="kpi-label">ƒças j√≠zdy</div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h2>Stav a ovl√°d√°n√≠</h2>
        <div class="form-row">
          <label>Aktu√°ln√≠ re≈æim</label>
          <input type="text" id="current-mode" disabled value="P≈ôipraven">
        </div>
        <div class="form-row">
          <label>GPS sou≈ôadnice</label>
          <input type="text" id="gps-coords" disabled value="ƒåek√° na GPS...">
        </div>
        <div class="buttons">
          <button class="btn btn-primary" id="btn-gps">Aktivovat GPS</button>
          <button class="btn btn-warning" id="btn-simulate">Simulace</button>
          <button class="btn btn-secondary" id="btn-saved-trips">Ulo≈æen√© stazky</button>
          <button class="btn btn-secondary" onclick="exportToJSON()">Export JSON</button>
          <button class="btn btn-secondary" onclick="exportToCSV()">Export CSV</button>
          <button class="btn btn-danger" id="btn-end-trip" disabled>Ukonƒçit stazku</button>
        </div>
      </div>
    </div>

    <div class="right-panel">
      <!-- Screen 1: Intro -->
      <div class="card screen active" id="screen-1">
        <h2>V√≠tejte</h2>
        <p class="info-text">Syst√©m pro evidenci j√≠zd a stazek. Pro start aktivujte GPS nebo pou≈æijte simulaci.</p>
        <div class="buttons">
          <button class="btn btn-primary" onclick="goToStep(2)">Nov√° stazka</button>
          <button class="btn btn-secondary" onclick="showSavedTrips()">Zobrazit ulo≈æen√©</button>
        </div>
      </div>

      <!-- Screen 2: Driver -->
      <div class="card screen" id="screen-2">
        <h2>√ödaje o ≈ôidiƒçi</h2>
        <div class="form-row">
          <label>Jm√©no ≈ôidiƒçe</label>
          <input type="text" id="driver-name" placeholder="Jan Nov√°k">
        </div>
        <div class="form-row">
          <label>ID ≈ôidiƒçe</label>
          <input type="text" id="driver-id" placeholder="12345">
        </div>
        <div class="form-row">
          <label>RZ vozidla</label>
          <input type="text" id="vehicle-plate" placeholder="1A2 3456">
        </div>
        <div class="buttons">
          <button class="btn btn-secondary" onclick="goToStep(1)">Zpƒõt</button>
          <button class="btn btn-primary" onclick="saveDriver()">Pokraƒçovat</button>
        </div>
      </div>

      <!-- Screen 3: Trip Start -->
      <div class="card screen" id="screen-3">
        <h2>Zah√°jen√≠ stazky</h2>
        <div class="form-row">
          <label>ƒå√≠slo stazky</label>
          <input type="number" id="trip-number" value="1">
        </div>
        <div class="form-row">
          <label>Start m√≠sto</label>
          <input type="text" id="start-place" placeholder="Naƒçte se z GPS">
        </div>
        <div class="form-row">
          <label>Tachometr (km)</label>
          <input type="number" id="start-odo" value="0">
        </div>
        <div class="form-row">
          <label>N√°klad</label>
          <input type="text" id="cargo" placeholder="Popis n√°kladu">
        </div>
        <div class="buttons">
          <button class="btn btn-secondary" onclick="goToStep(2)">Zpƒõt</button>
          <button class="btn btn-success" onclick="startTrip()">Zah√°jit stazku</button>
        </div>
      </div>

      <!-- Screen 4: Driving -->
      <div class="card screen" id="screen-4">
        <h2>Re≈æim j√≠zdy</h2>
        <p class="info-text">Vyberte aktu√°ln√≠ ƒçinnost:</p>
        <div class="mode-buttons">
          <button class="mode-btn" data-mode="driving" onclick="setMode('driving')">üöõ J√≠zda</button>
          <button class="mode-btn" data-mode="loading" onclick="setMode('loading')">üì¶ Nakl√°dka</button>
          <button class="mode-btn" data-mode="unloading" onclick="setMode('unloading')">üì§ Vykl√°dka</button>
          <button class="mode-btn" data-mode="break" onclick="setMode('break')">‚òï P≈ôest√°vka</button>
        </div>
        <div class="info-text" id="trip-info" style="margin-top:1rem"></div>
        <div class="buttons">
          <button class="btn btn-warning" onclick="pauseTrip()">Pozastavit</button>
          <button class="btn btn-danger" onclick="goToStep(5)">Ukonƒçit stazku</button>
        </div>
      </div>

      <!-- Screen 5: End -->
      <div class="card screen" id="screen-5">
        <h2>Ukonƒçen√≠ stazky</h2>
        <div class="form-row">
          <label>Koneƒçn√© m√≠sto</label>
          <div style="display:flex;gap:0.5rem">
            <input type="text" id="end-place" placeholder="Naƒçte se z GPS" style="flex:1">
            <button class="btn btn-secondary" onclick="loadCurrentGPS()">Naƒç√≠st GPS</button>
          </div>
        </div>
        <div class="form-row">
          <label>Tachometr (km)</label>
          <input type="number" id="end-odo">
        </div>
        <div class="form-row">
          <label>Palivo (l)</label>
          <input type="number" id="fuel" step="0.1">
        </div>
        <div class="buttons">
          <button class="btn btn-secondary" onclick="goToStep(4)">Zpƒõt</button>
          <button class="btn btn-success" onclick="finishTrip()">Ulo≈æit a zobrazit sum√°≈ô</button>
        </div>
      </div>

      <!-- Screen 6: Summary -->
      <div class="card screen" id="screen-6">
        <h2>Sum√°≈ô stazky</h2>
        <div id="summary-content"></div>
        <div class="buttons">
          <button class="btn btn-primary" onclick="newTrip()">Nov√° stazka</button>
          <button class="btn btn-secondary" onclick="showSavedTrips()">Zobrazit ulo≈æen√©</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for loading/unloading details -->
  <div class="modal" id="cargo-modal">
    <div class="modal-content cargo-modal">
      <div class="modal-header">
        <h2 id="cargo-modal-title">üì¶ Detaily nakl√°dky</h2>
        <button class="close-btn" onclick="closeCargoModal()">&times;</button>
      </div>
      <div class="form-row">
        <label>Pro koho / Od koho</label>
        <input type="text" id="cargo-client" placeholder="N√°zev firmy nebo jm√©no">
      </div>
      <div class="form-row">
        <label>Co (popis zbo≈æ√≠)</label>
        <input type="text" id="cargo-description" placeholder="Nap≈ô. stavebn√≠ materi√°l, potraviny...">
      </div>
      <div class="form-row">
        <label>Mno≈æstv√≠</label>
        <div style="display:flex;gap:0.5rem">
          <input type="number" id="cargo-amount" placeholder="0" style="flex:1">
          <select id="cargo-unit" style="flex:1">
            <option value="ks">ks</option>
            <option value="kg">kg</option>
            <option value="t">t</option>
            <option value="m3">m¬≥</option>
            <option value="palety">palety</option>
            <option value="bedny">bedny</option>
            <option value="pytle">pytle</option>
            <option value="barely">barely</option>
            <option value="kontejnery">kontejnery</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <label>M√≠sto</label>
        <input type="text" id="cargo-location" placeholder="Naƒçte se z GPS">
      </div>
      <div class="buttons">
        <button class="btn btn-secondary" onclick="closeCargoModal()">Zru≈°it</button>
        <button class="btn btn-success" onclick="saveCargoDetails()">Ulo≈æit</button>
      </div>
    </div>
  </div>

  <!-- Modal for stop detection -->
  <div class="modal" id="stop-modal">
    <div class="modal-content stop-modal">
      <div class="modal-header">
        <h2>‚ö†Ô∏è Vozidlo stoj√≠ d√©le ne≈æ 10 sekund</h2>
        <button class="close-btn" onclick="closeStopModal()">&times;</button>
      </div>
      <p class="info-text">Vyberte d≈Øvod zastaven√≠ nebo zav≈ôete pro pokraƒçov√°n√≠ v j√≠zdƒõ:</p>
      <div class="stop-buttons">
        <button class="stop-btn" onclick="handleStop('loading')">üì¶ Nakl√°dka</button>
        <button class="stop-btn" onclick="handleStop('unloading')">üì§ Vykl√°dka</button>
        <button class="stop-btn" onclick="handleStop('break')">‚òï P≈ôest√°vka</button>
        <button class="stop-btn" onclick="handleStop('idle')">‚è∏Ô∏è Prostoj</button>
      </div>
      <div class="buttons" style="margin-top:1rem">
        <button class="btn btn-secondary" onclick="closeStopModal()">Ignorovat - pokraƒçovat v j√≠zdƒõ</button>
      </div>
    </div>
  </div>

  <!-- Modal for saved trips -->
  <div class="modal" id="trips-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Ulo≈æen√© stazky</h2>
        <button class="close-btn" onclick="closeSavedTrips()">&times;</button>
      </div>
      <div class="trip-list" id="trip-list"></div>
    </div>
  </div>

  <!-- Modal for editing trip -->
  <div class="modal" id="edit-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Upravit stazku</h2>
        <button class="close-btn" onclick="closeEditModal()">&times;</button>
      </div>
      <div id="edit-form">
        <div class="form-row">
          <label>ƒå√≠slo stazky</label>
          <input type="number" id="edit-trip-number">
        </div>
        <div class="form-row">
          <label>≈òidiƒç</label>
          <input type="text" id="edit-driver-name">
        </div>
        <div class="form-row">
          <label>RZ vozidla</label>
          <input type="text" id="edit-vehicle-plate">
        </div>
        <div class="form-row">
          <label>Start m√≠sto</label>
          <input type="text" id="edit-start-place">
        </div>
        <div class="form-row">
          <label>Konec m√≠sto</label>
          <input type="text" id="edit-end-place">
        </div>
        <div class="form-row">
          <label>N√°klad</label>
          <input type="text" id="edit-cargo">
        </div>
        <div class="buttons">
          <button class="btn btn-secondary" onclick="closeEditModal()">Zru≈°it</button>
          <button class="btn btn-success" onclick="saveEditedTrip()">Ulo≈æit zmƒõny</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // State management
    let state = {
      currentStep: 1,
      tripActive: false,
      tripData: {},
      currentMode: 'idle',
      startTime: null,
      odometer: 0,
      distance: 0,
      speed: 0,
      gpsActive: false,
      gpsWatchId: null,
      simulating: false,
      simulationInterval: null,
      lastPosition: null,
      trips: [],
      editingTripId: null,
      pausedTrip: null,
      map: null,
      vehicleMarker: null,
      routePolyline: null,
      routeCoordinates: [],
      stopDetection: {
        stopTime: 0,
        stopModalShown: false,
        checkInterval: null,
        lastMovementTime: Date.now()
      },
      cargoOperations: [],
      currentCargoType: null,
      wakeLock: null
    };

    // Wake Lock API for keeping screen active during trips
    async function requestWakeLock() {
      try {
        if ('wakeLock' in navigator) {
          state.wakeLock = await navigator.wakeLock.request('screen');
          console.log('Wake lock acquired');
        }
      } catch (err) {
        console.log('Wake lock failed:', err);
      }
    }

    function releaseWakeLock() {
      if (state.wakeLock) {
        state.wakeLock.release();
        state.wakeLock = null;
        console.log('Wake lock released');
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      updateClock();
      setInterval(updateClock, 1000);
      loadSavedData();
      loadTrips();
      initializeMap();
      startStopDetection();
      
      // Check for GPS support
      if (!navigator.geolocation) {
        document.getElementById('gps-status').textContent = 'GPS nepodporov√°no';
        document.getElementById('btn-gps').disabled = true;
      }
      
      // Fix end trip button
      document.getElementById('btn-end-trip').addEventListener('click', function() {
        goToStep(5);
      });
    });

    // Stop detection system - only works in driving mode
    function startStopDetection() {
      state.stopDetection.checkInterval = setInterval(() => {
        if (state.tripActive && state.currentMode === 'driving') {
          // Check if vehicle is stopped (speed < 5 km/h)
          if (state.speed < 5) {
            state.stopDetection.stopTime++;
            
            // Show modal after 10 seconds of stopping
            if (state.stopDetection.stopTime >= 10 && !state.stopDetection.stopModalShown) {
              showStopModal();
            }
          } else {
            // Vehicle is moving - reset stop detection
            if (state.stopDetection.stopModalShown) {
              closeStopModal();
            }
            state.stopDetection.stopTime = 0;
            state.stopDetection.lastMovementTime = Date.now();
          }
        }
      }, 1000);
    }

    function showStopModal() {
      state.stopDetection.stopModalShown = true;
      document.getElementById('stop-modal').classList.add('active');
      
      // Play sound notification if possible
      try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLaiTYIGWm98OScTgwOUazn4bNgGwY3lNr0yHkqBSh+zPLaiDYIHWq+8+OWT');
        audio.volume = 0.3;
        audio.play();
      } catch(e) {}
    }

    function closeStopModal() {
      state.stopDetection.stopModalShown = false;
      state.stopDetection.stopTime = 0;
      document.getElementById('stop-modal').classList.remove('active');
    }

    function handleStop(reason) {
      if (reason === 'loading' || reason === 'unloading') {
        // Show cargo details modal
        state.currentCargoType = reason;
        document.getElementById('cargo-modal-title').textContent = 
          reason === 'loading' ? 'üì¶ Detaily nakl√°dky' : 'üì§ Detaily vykl√°dky';
        
        // Pre-fill location with current GPS
        if (state.lastPosition) {
          document.getElementById('cargo-location').value = 
            `GPS: ${state.lastPosition.latitude.toFixed(4)}, ${state.lastPosition.longitude.toFixed(4)}`;
        }
        
        document.getElementById('cargo-modal').classList.add('active');
        closeStopModal();
      } else {
        // Just change mode for break or idle
        setMode(reason);
        closeStopModal();
      }
    }

    function closeCargoModal() {
      document.getElementById('cargo-modal').classList.remove('active');
      // Clear form
      document.getElementById('cargo-client').value = '';
      document.getElementById('cargo-description').value = '';
      document.getElementById('cargo-amount').value = '';
      document.getElementById('cargo-location').value = '';
    }

    function saveCargoDetails() {
      const operation = {
        type: state.currentCargoType,
        client: document.getElementById('cargo-client').value,
        description: document.getElementById('cargo-description').value,
        amount: document.getElementById('cargo-amount').value,
        unit: document.getElementById('cargo-unit').value,
        location: document.getElementById('cargo-location').value,
        timestamp: new Date().toISOString(),
        gps: state.lastPosition ? {
          lat: state.lastPosition.latitude,
          lng: state.lastPosition.longitude
        } : null
      };
      
      // Add to operations list
      state.cargoOperations.push(operation);
      
      // Change mode
      setMode(state.currentCargoType);
      
      closeCargoModal();
      
      // Show confirmation
      const typeText = state.currentCargoType === 'loading' ? 'Nakl√°dka' : 'Vykl√°dka';
      alert(`${typeText} zaznamen√°na: ${operation.amount} ${operation.unit} - ${operation.description}`);
    }

    // Initialize Leaflet map
    function initializeMap() {
      // Create map centered on Prague
      state.map = L.map('leaflet-map').setView([50.0755, 14.4378], 13);
      
      // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(state.map);
      
      // Create vehicle marker with custom icon
      const vehicleIcon = L.divIcon({
        html: 'üöõ',
        iconSize: [30, 30],
        className: 'vehicle-marker'
      });
      
      state.vehicleMarker = L.marker([50.0755, 14.4378], {icon: vehicleIcon}).addTo(state.map);
      
      // Initialize empty polyline for route
      state.routePolyline = L.polyline([], {color: '#3b82f6', weight: 4, opacity: 0.7}).addTo(state.map);
    }

    function updateClock() {
      document.getElementById('time').textContent = new Date().toLocaleTimeString('cs-CZ');
    }

    // GPS functions
    document.getElementById('btn-gps').addEventListener('click', toggleGPS);
    
    function toggleGPS() {
      if (!state.gpsActive) {
        // Request GPS permission and start tracking
        navigator.geolocation.getCurrentPosition(
          (position) => {
            // Success - start watching position
            state.gpsActive = true;
            state.lastPosition = position.coords;
            updateGPSDisplay(position.coords);
            updateMapPosition(position.coords.latitude, position.coords.longitude);
            
            state.gpsWatchId = navigator.geolocation.watchPosition(
              (pos) => {
                updatePosition(pos.coords);
              },
              (error) => {
                console.error('GPS error:', error);
                document.getElementById('gps-status').textContent = 'GPS chyba';
              },
              {
                enableHighAccuracy: true,
                maximumAge: 1000,
                timeout: 5000
              }
            );
            
            document.getElementById('btn-gps').textContent = 'Vypnout GPS';
            document.getElementById('gps-status').textContent = 'GPS aktivn√≠';
            document.getElementById('gps-status-dot').className = 'dot green';
          },
          (error) => {
            alert('GPS p≈ô√≠stup zam√≠tnut. Pou≈æijte simulaci.');
            console.error('GPS error:', error);
          }
        );
      } else {
        // Stop GPS tracking
        if (state.gpsWatchId) {
          navigator.geolocation.clearWatch(state.gpsWatchId);
          state.gpsWatchId = null;
        }
        state.gpsActive = false;
        document.getElementById('btn-gps').textContent = 'Aktivovat GPS';
        document.getElementById('gps-status').textContent = 'GPS vypnuto';
        document.getElementById('gps-status-dot').className = 'dot red';
      }
    }

    function updatePosition(coords) {
      if (state.lastPosition) {
        // Calculate distance using Haversine formula
        const R = 6371; // Earth radius in km
        const dLat = (coords.latitude - state.lastPosition.latitude) * Math.PI / 180;
        const dLon = (coords.longitude - state.lastPosition.longitude) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(state.lastPosition.latitude * Math.PI / 180) * 
                  Math.cos(coords.latitude * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distance = R * c;
        
        if (state.currentMode === 'driving' && state.tripActive) {
          state.distance += distance;
          state.odometer += distance;
        }
      }
      
      // Update speed
      if (coords.speed !== null) {
        state.speed = coords.speed * 3.6; // Convert m/s to km/h
      } else {
        // Calculate speed from position change
        if (state.lastPosition && state.lastPosition.timestamp) {
          const timeDiff = (Date.now() - state.lastPosition.timestamp) / 1000; // seconds
          const distKm = haversineDistance(state.lastPosition, coords);
          if (timeDiff > 0) {
            state.speed = (distKm / timeDiff) * 3600; // km/h
          }
        }
      }
      
      // Store timestamp for speed calculation
      coords.timestamp = Date.now();
      
      state.lastPosition = coords;
      updateGPSDisplay(coords);
      updateKPIs();
      
      // Update map
      updateMapPosition(coords.latitude, coords.longitude);
      
      // Add to route if trip is active
      if (state.tripActive) {
        addRoutePoint(coords.latitude, coords.longitude);
      }
      
      // Reset stop detection if moving fast enough
      if (state.speed > 5) {
        state.stopDetection.stopTime = 0;
        if (state.stopDetection.stopModalShown) {
          closeStopModal();
          // Auto-switch back to driving if we were in another mode
          if (state.currentMode !== 'driving' && state.tripActive) {
            setMode('driving');
          }
        }
      }
    }

    function haversineDistance(pos1, pos2) {
      const R = 6371; // Earth radius in km
      const dLat = (pos2.latitude - pos1.latitude) * Math.PI / 180;
      const dLon = (pos2.longitude - pos1.longitude) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(pos1.latitude * Math.PI / 180) * 
                Math.cos(pos2.latitude * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function updateMapPosition(lat, lng) {
      if (state.vehicleMarker) {
        state.vehicleMarker.setLatLng([lat, lng]);
        state.map.panTo([lat, lng]);
      }
    }

    function addRoutePoint(lat, lng) {
      state.routeCoordinates.push([lat, lng]);
      state.routePolyline.setLatLngs(state.routeCoordinates);
    }

    function clearRoute() {
      state.routeCoordinates = [];
      state.routePolyline.setLatLngs([]);
    }

    function updateGPSDisplay(coords) {
      document.getElementById('gps-coords').value = 
        `${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}`;
      
      // Update start/end place with reverse geocoding (simplified)
      if (state.currentStep === 3) {
        document.getElementById('start-place').value = 
          `GPS: ${coords.latitude.toFixed(4)}, ${coords.longitude.toFixed(4)}`;
      } else if (state.currentStep === 5) {
        document.getElementById('end-place').value = 
          `GPS: ${coords.latitude.toFixed(4)}, ${coords.longitude.toFixed(4)}`;
      }
    }

    // Simulation
    document.getElementById('btn-simulate').addEventListener('click', toggleSimulation);
    
    function toggleSimulation() {
      state.simulating = !state.simulating;
      
      if (state.simulating) {
        // Stop real GPS if active
        if (state.gpsActive) {
          toggleGPS();
        }
        
        document.getElementById('btn-simulate').textContent = 'Zastavit simulaci';
        document.getElementById('gps-status').textContent = 'Simulace aktivn√≠';
        document.getElementById('gps-status-dot').className = 'dot yellow';
        
        // Initialize simulated position (Prague center)
        if (!state.lastPosition) {
          state.lastPosition = {
            latitude: 50.0755,
            longitude: 14.4378
          };
        }
        
        state.simulationInterval = setInterval(() => {
          if (state.tripActive) {
            if (state.currentMode === 'driving') {
              // Simulate movement along a path
              state.lastPosition.latitude += (Math.random() - 0.5) * 0.001;
              state.lastPosition.longitude += (Math.random() - 0.5) * 0.001;
              
              // Simulate speed between 30-80 km/h
              state.speed = 30 + Math.random() * 50;
              const kmPerSecond = state.speed / 3600;
              state.distance += kmPerSecond;
              state.odometer += kmPerSecond;
              
              updateGPSDisplay(state.lastPosition);
              updateMapPosition(state.lastPosition.latitude, state.lastPosition.longitude);
              addRoutePoint(state.lastPosition.latitude, state.lastPosition.longitude);
              
              // Reset stop detection when moving
              state.stopDetection.stopTime = 0;
              if (state.stopDetection.stopModalShown) {
                closeStopModal();
              }
            } else if (state.currentMode === 'loading' || state.currentMode === 'unloading' || 
                       state.currentMode === 'break' || state.currentMode === 'idle') {
              // Vehicle is intentionally stopped
              state.speed = 0;
              
              // Occasionally simulate small movements (0-5 km/h) to test stop detection
              if (Math.random() < 0.1) {
                state.speed = Math.random() * 5;
                state.lastPosition.latitude += (Math.random() - 0.5) * 0.00001;
                state.lastPosition.longitude += (Math.random() - 0.5) * 0.00001;
                updateMapPosition(state.lastPosition.latitude, state.lastPosition.longitude);
              }
            }
          } else {
            state.speed = 0;
          }
          
          updateKPIs();
        }, 1000);
      } else {
        document.getElementById('btn-simulate').textContent = 'Simulace';
        document.getElementById('gps-status').textContent = 'Simulace vypnuta';
        document.getElementById('gps-status-dot').className = 'dot red';
        
        if (state.simulationInterval) {
          clearInterval(state.simulationInterval);
          state.simulationInterval = null;
        }
        
        state.speed = 0;
        updateKPIs();
      }
    }

    function updateKPIs() {
      document.getElementById('speed').textContent = Math.round(state.speed);
      document.getElementById('distance').textContent = state.distance.toFixed(1);
      document.getElementById('odometer').textContent = Math.round(state.odometer);
      
      if (state.startTime) {
        const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
        const hours = Math.floor(elapsed / 3600);
        const minutes = Math.floor((elapsed % 3600) / 60);
        document.getElementById('duration').textContent = 
          `${hours}:${minutes.toString().padStart(2, '0')}`;
      }
    }

    // Trip management
    function goToStep(step) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(`screen-${step}`).classList.add('active');
      
      document.querySelectorAll('.step').forEach((s, i) => {
        s.classList.remove('active', 'done');
        if (i + 1 < step) s.classList.add('done');
        if (i + 1 === step) s.classList.add('active');
      });
      
      state.currentStep = step;
      
      if (step === 5) {
        // Auto-fill end location with current GPS
        document.getElementById('end-odo').value = Math.round(state.odometer);
        loadCurrentGPS();
      }
    }

    function loadCurrentGPS() {
      if (state.lastPosition) {
        document.getElementById('end-place').value = 
          `GPS: ${state.lastPosition.latitude.toFixed(4)}, ${state.lastPosition.longitude.toFixed(4)}`;
      } else {
        document.getElementById('end-place').value = 'GPS nen√≠ dostupn√°';
      }
    }

    function saveDriver() {
      const name = document.getElementById('driver-name').value;
      const id = document.getElementById('driver-id').value;
      const plate = document.getElementById('vehicle-plate').value;
      
      if (!name || !plate) {
        alert('Vypl≈àte jm√©no ≈ôidiƒçe a RZ vozidla');
        return;
      }
      
      state.tripData.driverName = name;
      state.tripData.driverId = id;
      state.tripData.vehiclePlate = plate;
      
      localStorage.setItem('driverData', JSON.stringify({name, id, plate}));
      goToStep(3);
    }

    function startTrip() {
      state.tripData.id = Date.now().toString();
      state.tripData.tripNumber = document.getElementById('trip-number').value;
      state.tripData.startPlace = document.getElementById('start-place').value || 'Nezn√°m√© m√≠sto';
      state.tripData.startOdo = parseInt(document.getElementById('start-odo').value) || 0;
      state.tripData.cargo = document.getElementById('cargo').value;
      state.tripData.startTime = new Date();
      state.tripData.status = 'active';
      
      state.odometer = state.tripData.startOdo;
      state.tripActive = true;
      state.startTime = Date.now();
      state.cargoOperations = []; // Reset cargo operations for new trip
      
      document.getElementById('btn-end-trip').disabled = false;
      
      // Request wake lock to keep screen active
      requestWakeLock();
      document.getElementById('current-mode').value = 'J√≠zda zah√°jena';
      
      // Clear route on map
      clearRoute();
      
      // Add starting position to route
      if (state.lastPosition) {
        addRoutePoint(state.lastPosition.latitude, state.lastPosition.longitude);
      }
      
      goToStep(4);
      setMode('driving');
      updateTripInfo();
    }

    function setMode(mode) {
      state.currentMode = mode;
      
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.mode === mode) {
          btn.classList.add('active');
        }
      });
      
      const modeNames = {
        'driving': 'J√≠zda',
        'loading': 'Nakl√°dka',
        'unloading': 'Vykl√°dka',
        'break': 'P≈ôest√°vka'
      };
      
      document.getElementById('current-mode').value = modeNames[mode] || mode;
    }

    function updateTripInfo() {
      if (state.tripActive) {
        document.getElementById('trip-info').innerHTML = 
          `<strong>Stazka #${state.tripData.tripNumber}</strong><br>
           Start: ${state.tripData.startPlace}<br>
           ≈òidiƒç: ${state.tripData.driverName}`;
      }
    }

    function pauseTrip() {
      state.pausedTrip = {...state.tripData, distance: state.distance, odometer: state.odometer};
      state.tripActive = false;
      releaseWakeLock();
      saveTrips();
      alert('Stazka pozastavena. M≈Ø≈æete ji obnovit v ulo≈æen√Ωch stazk√°ch.');
      goToStep(1);
    }

    function finishTrip() {
      state.tripData.endPlace = document.getElementById('end-place').value || 'Nezn√°m√© m√≠sto';
      state.tripData.endOdo = parseInt(document.getElementById('end-odo').value) || state.odometer;
      state.tripData.fuel = document.getElementById('fuel').value;
      state.tripData.endTime = new Date();
      state.tripData.distance = state.distance;
      state.tripData.status = 'completed';
      state.tripData.cargoOperations = state.cargoOperations; // Save cargo operations
      
      // Stop simulation/GPS if running
      if (state.simulating) toggleSimulation();
      if (state.gpsActive) toggleGPS();
      
      // Release wake lock
      releaseWakeLock();
      
      // Save trip
      saveTrips();
      
      // Generate summary with cargo operations
      let cargoSummary = '';
      if (state.cargoOperations.length > 0) {
        cargoSummary = '<p><strong>Nakl√°dky/Vykl√°dky:</strong></p><ul>';
        state.cargoOperations.forEach(op => {
          const icon = op.type === 'loading' ? 'üì¶' : 'üì§';
          const typeText = op.type === 'loading' ? 'Nakl√°dka' : 'Vykl√°dka';
          cargoSummary += `<li>${icon} ${typeText}: ${op.amount} ${op.unit} - ${op.description}<br>
                           Pro/Od: ${op.client || '-'}<br>
                           M√≠sto: ${op.location}<br>
                           ƒåas: ${new Date(op.timestamp).toLocaleString('cs-CZ')}</li>`;
        });
        cargoSummary += '</ul>';
      }
      
      const summary = `
        <div style="line-height: 1.6">
          <p><strong>Stazka ƒç.:</strong> ${state.tripData.tripNumber}</p>
          <p><strong>≈òidiƒç:</strong> ${state.tripData.driverName}</p>
          <p><strong>Vozidlo:</strong> ${state.tripData.vehiclePlate}</p>
          <p><strong>Trasa:</strong> ${state.tripData.startPlace} ‚Üí ${state.tripData.endPlace}</p>
          <p><strong>Vzd√°lenost:</strong> ${state.distance.toFixed(1)} km</p>
          <p><strong>Tachometr:</strong> ${state.tripData.startOdo} ‚Üí ${state.tripData.endOdo} km</p>
          <p><strong>ƒåas:</strong> ${state.tripData.startTime.toLocaleString('cs-CZ')} - ${state.tripData.endTime.toLocaleString('cs-CZ')}</p>
          <p><strong>N√°klad (start):</strong> ${state.tripData.cargo || '-'}</p>
          ${cargoSummary}
          <p><strong>Palivo:</strong> ${state.tripData.fuel || '-'} l</p>
        </div>
      `;
      
      document.getElementById('summary-content').innerHTML = summary;
      
      // Reset state
      state.tripActive = false;
      state.cargoOperations = [];
      document.getElementById('btn-end-trip').disabled = true;
      
      goToStep(6);
    }

    // Export functions with cargo operations
    function exportToJSON() {
      const data = {
        trips: state.trips.map(trip => ({
          ...trip,
          cargoOperations: trip.cargoOperations || []
        }))
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `stazky_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
    }

    function exportToCSV() {
      let csv = 'ƒå√≠slo stazky,≈òidiƒç,Vozidlo,Start m√≠sto,Konec m√≠sto,Vzd√°lenost km,Start ƒças,Konec ƒças,Typ operace,Klient,Popis,Mno≈æstv√≠,Jednotka,M√≠sto operace,ƒåas operace\n';
      
      state.trips.forEach(trip => {
        const baseRow = `${trip.tripNumber},${trip.driverName},${trip.vehiclePlate},${trip.startPlace},${trip.endPlace || ''},${(trip.distance || 0).toFixed(1)},${trip.startTime},${trip.endTime || ''}`;
        
        if (trip.cargoOperations && trip.cargoOperations.length > 0) {
          trip.cargoOperations.forEach(op => {
            csv += `${baseRow},${op.type},${op.client},${op.description},${op.amount},${op.unit},${op.location},${op.timestamp}\n`;
          });
        } else {
          csv += `${baseRow},-,-,-,-,-,-,-\n`;
        }
      });
      
      const blob = new Blob(['\ufeff' + csv], {type: 'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `stazky_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    }

    function newTrip() {
      state.distance = 0;
      state.tripData = {};
      document.getElementById('distance').textContent = '0.0';
      document.getElementById('speed').textContent = '0';
      document.getElementById('duration').textContent = '0:00';
      
      // Clear route on map
      clearRoute();
      
      goToStep(2);
    }

    // Saved trips management
    document.getElementById('btn-saved-trips').addEventListener('click', showSavedTrips);
    
    function loadTrips() {
      state.trips = JSON.parse(localStorage.getItem('trips') || '[]');
    }

    function saveTrips() {
      // Add or update current trip
      if (state.tripData.id) {
        const existingIndex = state.trips.findIndex(t => t.id === state.tripData.id);
        if (existingIndex >= 0) {
          state.trips[existingIndex] = state.tripData;
        } else {
          state.trips.push(state.tripData);
        }
      }
      
      localStorage.setItem('trips', JSON.stringify(state.trips));
    }

    function showSavedTrips() {
      loadTrips();
      const modal = document.getElementById('trips-modal');
      const list = document.getElementById('trip-list');
      
      if (state.trips.length === 0) {
        list.innerHTML = '<p class="info-text">≈Ω√°dn√© ulo≈æen√© stazky</p>';
      } else {
        list.innerHTML = state.trips.map(trip => `
          <div class="trip-item">
            <div class="trip-header">
              <div class="trip-title">Stazka #${trip.tripNumber}</div>
              <div class="trip-status ${trip.status}">${trip.status === 'active' ? 'Aktivn√≠' : 'Dokonƒçena'}</div>
            </div>
            <div class="trip-details">
              ≈òidiƒç: ${trip.driverName}<br>
              Vozidlo: ${trip.vehiclePlate}<br>
              Trasa: ${trip.startPlace} ${trip.endPlace ? '‚Üí ' + trip.endPlace : ''}<br>
              Vzd√°lenost: ${trip.distance ? trip.distance.toFixed(1) : '0'} km<br>
              Datum: ${new Date(trip.startTime).toLocaleDateString('cs-CZ')}
            </div>
            <div class="trip-actions">
              <button class="btn btn-primary" onclick="editTrip('${trip.id}')">Upravit</button>
              ${trip.status === 'active' ? 
                `<button class="btn btn-success" onclick="continueTrip('${trip.id}')">Pokraƒçovat</button>` : 
                `<button class="btn btn-secondary" onclick="viewTrip('${trip.id}')">Zobrazit</button>`
              }
              <button class="btn btn-danger" onclick="deleteTrip('${trip.id}')">Smazat</button>
            </div>
          </div>
        `).join('');
      }
      
      modal.classList.add('active');
    }

    function closeSavedTrips() {
      document.getElementById('trips-modal').classList.remove('active');
    }

    function editTrip(tripId) {
      const trip = state.trips.find(t => t.id === tripId);
      if (!trip) return;
      
      state.editingTripId = tripId;
      
      document.getElementById('edit-trip-number').value = trip.tripNumber;
      document.getElementById('edit-driver-name').value = trip.driverName;
      document.getElementById('edit-vehicle-plate').value = trip.vehiclePlate;
      document.getElementById('edit-start-place').value = trip.startPlace;
      document.getElementById('edit-end-place').value = trip.endPlace || '';
      document.getElementById('edit-cargo').value = trip.cargo || '';
      
      document.getElementById('edit-modal').classList.add('active');
      closeSavedTrips();
    }

    function closeEditModal() {
      document.getElementById('edit-modal').classList.remove('active');
      state.editingTripId = null;
    }

    function saveEditedTrip() {
      if (!state.editingTripId) return;
      
      const trip = state.trips.find(t => t.id === state.editingTripId);
      if (!trip) return;
      
      trip.tripNumber = document.getElementById('edit-trip-number').value;
      trip.driverName = document.getElementById('edit-driver-name').value;
      trip.vehiclePlate = document.getElementById('edit-vehicle-plate').value;
      trip.startPlace = document.getElementById('edit-start-place').value;
      trip.endPlace = document.getElementById('edit-end-place').value;
      trip.cargo = document.getElementById('edit-cargo').value;
      
      localStorage.setItem('trips', JSON.stringify(state.trips));
      
      alert('Stazka byla upravena');
      closeEditModal();
      showSavedTrips();
    }

    function continueTrip(tripId) {
      const trip = state.trips.find(t => t.id === tripId);
      if (!trip || trip.status !== 'active') return;
      
      // Load trip data
      state.tripData = trip;
      state.distance = trip.distance || 0;
      state.odometer = trip.startOdo + state.distance;
      state.startTime = new Date(trip.startTime).getTime();
      state.tripActive = true;
      
      // Request wake lock to keep screen active
      requestWakeLock();
      
      // Load driver data
      document.getElementById('driver-name').value = trip.driverName;
      document.getElementById('driver-id').value = trip.driverId || '';
      document.getElementById('vehicle-plate').value = trip.vehiclePlate;
      
      document.getElementById('btn-end-trip').disabled = false;
      
      closeSavedTrips();
      goToStep(4);
      setMode('driving');
      updateTripInfo();
      
      alert(`Pokraƒçov√°n√≠ ve stazce #${trip.tripNumber}`);
    }

    function viewTrip(tripId) {
      const trip = state.trips.find(t => t.id === tripId);
      if (!trip) return;
      
      const summary = `
        <div style="line-height: 1.6">
          <p><strong>Stazka ƒç.:</strong> ${trip.tripNumber}</p>
          <p><strong>≈òidiƒç:</strong> ${trip.driverName}</p>
          <p><strong>Vozidlo:</strong> ${trip.vehiclePlate}</p>
          <p><strong>Trasa:</strong> ${trip.startPlace} ‚Üí ${trip.endPlace || 'Nedokonƒçeno'}</p>
          <p><strong>Vzd√°lenost:</strong> ${(trip.distance || 0).toFixed(1)} km</p>
          <p><strong>Tachometr:</strong> ${trip.startOdo} ‚Üí ${trip.endOdo || '?'} km</p>
          <p><strong>ƒåas:</strong> ${new Date(trip.startTime).toLocaleString('cs-CZ')} ${trip.endTime ? '- ' + new Date(trip.endTime).toLocaleString('cs-CZ') : ''}</p>
          <p><strong>N√°klad:</strong> ${trip.cargo || '-'}</p>
          <p><strong>Palivo:</strong> ${trip.fuel || '-'} l</p>
        </div>
      `;
      
      document.getElementById('summary-content').innerHTML = summary;
      closeSavedTrips();
      goToStep(6);
    }

    function deleteTrip(tripId) {
      if (!confirm('Opravdu chcete smazat tuto stazku?')) return;
      
      state.trips = state.trips.filter(t => t.id !== tripId);
      localStorage.setItem('trips', JSON.stringify(state.trips));
      
      showSavedTrips();
    }

    function loadSavedData() {
      const driverData = JSON.parse(localStorage.getItem('driverData') || '{}');
      if (driverData.name) {
        document.getElementById('driver-name').value = driverData.name;
        document.getElementById('driver-id').value = driverData.id || '';
        document.getElementById('vehicle-plate').value = driverData.plate || '';
      }
      
      loadTrips();
      const maxTripNumber = Math.max(0, ...state.trips.map(t => parseInt(t.tripNumber) || 0));
      document.getElementById('trip-number').value = maxTripNumber + 1;
    }

    // Auto-update KPIs every second
    setInterval(() => {
      if (state.tripActive) {
        updateKPIs();
      }
    }, 1000);
  </script>
</body>
</html>
