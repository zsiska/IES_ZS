<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stazka Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            font-size: 1.5em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
        }

        .dropdown-menu {
            position: absolute;
            top: 80px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            min-width: 250px;
            display: none;
            z-index: 1000;
        }

        .dropdown-menu.show {
            display: block;
        }

        .menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .menu-item:hover {
            background: #f8f9fa;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .content {
            padding: 20px;
        }

        .form-section {
            background: white;
            margin-bottom: 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .section-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-content {
            padding: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid #e8f4fd;
            border-radius: 8px;
            font-size: 16px;
            background: #fafbfc;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }

        .input-field:disabled {
            background: #f0f0f0;
            color: #666;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .gps-status {
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: bold;
        }

        .gps-ok {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .gps-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .gps-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .trip-info {
            background: rgba(39, 174, 96, 0.1);
            border: 1px solid rgba(39, 174, 96, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }

        .trip-info.active {
            display: block;
        }

        .trip-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            background: rgba(255,255,255,0.7);
            padding: 15px;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #27ae60;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .action-buttons {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            z-index: 100;
        }

        .hidden {
            display: none !important;
        }

        .location-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
        }

        .saved-trips {
            max-height: 400px;
            overflow-y: auto;
        }

        .trip-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .trip-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .trip-details {
            color: #666;
            font-size: 0.9em;
        }

        .trip-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .input-row {
                grid-template-columns: 1fr;
            }
            
            .content {
                padding: 15px;
                padding-bottom: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="app-title">
                <span>üöõ</span>
                Stazka Pro
            </div>
            <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
        </div>

        <!-- Dropdown Menu -->
        <div class="dropdown-menu" id="dropdownMenu">
            <div class="menu-item" onclick="showSavedTrips()">
                <span>üóÇÔ∏è</span>
                <div>
                    <div>Ulo≈æen√© stazky</div>
                    <div style="font-size: 0.8em; color: #666;" id="menuTripsCount">0 stazek</div>
                </div>
            </div>
            <div class="menu-item" onclick="showNewTrip()">
                <span>üÜï</span>
                <div>Nov√° stazka</div>
            </div>
            <div class="menu-item" onclick="clearAllData()">
                <span>üóëÔ∏è</span>
                <div>Vymazat v≈°e</div>
            </div>
        </div>

        <div class="content">
            <!-- Nov√° stazka -->
            <div id="newTripScreen">
                <form id="tripForm">
                    <!-- √ödaje o ≈ôidiƒçi -->
                    <div class="form-section">
                        <div class="section-header">
                            <span>üë§</span>
                            √ödaje o ≈ôidiƒçi
                        </div>
                        <div class="section-content">
                            <div class="input-group">
                                <label class="input-label">Jm√©no a p≈ô√≠jmen√≠</label>
                                <input type="text" id="driverName" class="input-field" required>
                            </div>
                            <div class="input-group">
                                <label class="input-label">ƒå√≠slo stazky</label>
                                <input type="text" id="tripNumber" class="input-field" disabled>
                            </div>
                        </div>
                    </div>

                    <!-- Vozidlo -->
                    <div class="form-section">
                        <div class="section-header">
                            <span>üöö</span>
                            Vozidlo
                        </div>
                        <div class="section-content">
                            <div class="input-row">
                                <div class="input-group">
                                    <label class="input-label">SPZ vozidla</label>
                                    <input type="text" id="vehiclePlate" class="input-field" required>
                                </div>
                                <div class="input-group">
                                    <label class="input-label">Tachometr (km)</label>
                                    <input type="number" id="odometer" class="input-field" required>
                                </div>
                            </div>
                            <div class="input-group">
                                <label class="input-label">Typ vozidla</label>
                                <select id="vehicleType" class="input-field" required>
                                    <option value="">Vyberte typ</option>
                                    <option value="osobn√≠">Osobn√≠ automobil</option>
                                    <option value="n√°kladn√≠">N√°kladn√≠ automobil</option>
                                    <option value="autobus">Autobus</option>
                                    <option value="souprava">N√°kladn√≠ souprava</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Datum a m√≠sto -->
                    <div class="form-section">
                        <div class="section-header">
                            <span>üìÖ</span>
                            Datum a m√≠sto
                        </div>
                        <div class="section-content">
                            <div class="input-row">
                                <div class="input-group">
                                    <label class="input-label">Datum</label>
                                    <input type="date" id="workDate" class="input-field" required>
                                </div>
                                <div class="input-group">
                                    <label class="input-label">ƒåas zah√°jen√≠</label>
                                    <input type="time" id="startTime" class="input-field" required>
                                </div>
                            </div>
                            <div class="input-group">
                                <label class="input-label">M√≠sto zah√°jen√≠</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="startLocation" class="input-field" required style="flex: 1;">
                                    <button type="button" onclick="detectLocation()" style="padding: 10px; border: none; background: #667eea; color: white; border-radius: 5px;">üìç</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- GPS Status -->
                <div id="gpsStatus" class="gps-status gps-warning">
                    üîç Naƒç√≠t√°m GPS pozici...
                </div>

                <div id="locationInfo" class="location-display" style="display: none;">
                    <div>üìç <strong>Aktu√°ln√≠ pozice:</strong></div>
                    <div>≈†√≠≈ôka: <span id="latitude">---</span></div>
                    <div>D√©lka: <span id="longitude">---</span></div>
                    <div>P≈ôesnost: <span id="accuracy">---</span></div>
                    <div>ƒåas: <span id="lastUpdate">---</span></div>
                </div>

                <!-- Trip Info (bƒõhem j√≠zdy) -->
                <div id="tripInfo" class="trip-info">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <div style="font-size: 2em;">üöõ</div>
                        <div>
                            <div style="font-weight: bold; color: #27ae60; font-size: 1.2em;">J√≠zda prob√≠h√°</div>
                            <div style="color: #666;">Zah√°jeno: <span id="tripStartTime">---</span></div>
                        </div>
                    </div>
                    <div class="trip-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="tripDuration">00:00</div>
                            <div class="stat-label">Doba j√≠zdy</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="tripDistance">0.0</div>
                            <div class="stat-label">Km ujet√Ωch</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="gpsPoints">0</div>
                            <div class="stat-label">GPS bod≈Ø</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stopsCount">0</div>
                            <div class="stat-label">Zast√°vek</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ulo≈æen√© stazky -->
            <div id="savedTripsScreen" class="hidden">
                <div class="form-section">
                    <div class="section-header">
                        <span>üóÇÔ∏è</span>
                        Ulo≈æen√© stazky (<span id="savedTripsCount">0</span>)
                    </div>
                    <div class="section-content">
                        <div id="savedTripsList">
                            <div style="text-align: center; color: #666; padding: 40px;">
                                <div style="font-size: 3em; margin-bottom: 15px;">üìÅ</div>
                                <div>≈Ω√°dn√© ulo≈æen√© stazky</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons" id="actionButtons">
            <button type="button" class="btn btn-secondary" onclick="clearForm()">
                üóëÔ∏è Vymazat
            </button>
            <button type="submit" form="tripForm" class="btn">
                üöÄ Zah√°jit
            </button>
        </div>
    </div>

    <script>
        // Glob√°ln√≠ promƒõnn√©
        let isTracking = false;
        let tripStartTime = null;
        let currentRoute = [];
        let stops = [];
        let savedTrips = [];
        let nextTripNumber = 1;
        let watchId = null;
        let currentPosition = null;

        // Inicializace
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Aplikace se spou≈°t√≠...');
            initializeApp();
            requestGPSPermission();
        });

        function initializeApp() {
            // Nastaven√≠ aktu√°ln√≠ho data a ƒçasu
            const now = new Date();
            document.getElementById('workDate').valueAsDate = now;
            document.getElementById('startTime').value = now.toTimeString().substr(0,5);
            
            // Naƒçten√≠ ulo≈æen√Ωch dat
            loadSavedData();
            updateTripNumber();
            
            // Event listeners
            document.getElementById('tripForm').addEventListener('submit', startTrip);
            
            // Zav≈ôen√≠ menu p≈ôi kliknut√≠ mimo
            document.addEventListener('click', function(e) {
                const menu = document.getElementById('dropdownMenu');
                if (!menu.contains(e.target) && !e.target.closest('.menu-btn')) {
                    menu.classList.remove('show');
                }
            });

            console.log('‚úÖ Aplikace inicializov√°na');
        }

        function requestGPSPermission() {
            console.log('üì° Po≈æaduji GPS opr√°vnƒõn√≠...');
            
            if (!navigator.geolocation) {
                showGPSError('GPS nen√≠ podporov√°no');
                return;
            }

            const options = {
                enableHighAccuracy: false,
                timeout: 30000,
                maximumAge: 300000
            };

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    console.log('‚úÖ GPS pozice z√≠sk√°na:', position.coords);
                    handleGPSSuccess(position);
                    startGPSWatching();
                },
                function(error) {
                    console.error('‚ùå GPS chyba:', error);
                    handleGPSError(error);
                },
                options
            );
        }

        function startGPSWatching() {
            if (watchId) return;
            
            const options = {
                enableHighAccuracy: false,
                timeout: 30000,
                maximumAge: 60000
            };

            try {
                watchId = navigator.geolocation.watchPosition(
                    handleGPSSuccess,
                    handleGPSError,
                    options
                );
                console.log('üìç GPS sledov√°n√≠ spu≈°tƒõno');
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi spu≈°tƒõn√≠ GPS sledov√°n√≠:', error);
            }
        }

        function handleGPSSuccess(position) {
            currentPosition = position;
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            console.log('üìç GPS update:', {
                lat: lat.toFixed(6),
                lng: lng.toFixed(6),
                accuracy: Math.round(accuracy) + 'm'
            });

            // Aktualizace UI
            showGPSSuccess();
            updateLocationDisplay(lat, lng, accuracy);
            
            // Auto-detekce m√≠sta p≈ôi prvn√≠m naƒçten√≠
            if (!document.getElementById('startLocation').value) {
                detectLocationFromCoords(lat, lng);
            }

            // P≈ôid√°n√≠ bodu do trasy p≈ôi sledov√°n√≠
            if (isTracking) {
                addRoutePoint(position);
                updateTripStats();
            }
        }

        function handleGPSError(error) {
            console.error('‚ùå GPS chyba:', error);
            
            let message = 'GPS chyba';
            switch(error.code) {
                case 1:
                    message = 'GPS opr√°vnƒõn√≠ zam√≠tnuto. Povolte p≈ô√≠stup k poloze.';
                    break;
                case 2:
                    message = 'GPS pozice nedostupn√°. Zkontrolujte GPS na za≈ô√≠zen√≠.';
                    break;
                case 3:
                    message = 'GPS timeout. Zkuste to znovu.';
                    break;
            }
            
            showGPSError(message);
        }

        function showGPSSuccess() {
            const status = document.getElementById('gpsStatus');
            status.className = 'gps-status gps-ok';
            status.innerHTML = '‚úÖ GPS p≈ôipojeno a funguje';
            
            document.getElementById('locationInfo').style.display = 'block';
        }

        function showGPSError(message) {
            const status = document.getElementById('gpsStatus');
            status.className = 'gps-status gps-error';
            status.innerHTML = '‚ùå ' + message;
            
            document.getElementById('locationInfo').style.display = 'none';
        }

        function updateLocationDisplay(lat, lng, accuracy) {
            document.getElementById('latitude').textContent = lat.toFixed(6);
            document.getElementById('longitude').textContent = lng.toFixed(6);
            document.getElementById('accuracy').textContent = Math.round(accuracy) + ' m';
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        function detectLocation() {
            if (!currentPosition) {
                alert('‚ùå GPS pozice nen√≠ dostupn√°. Poƒçkejte na naƒçten√≠ GPS.');
                return;
            }
            
            const lat = currentPosition.coords.latitude;
            const lng = currentPosition.coords.longitude;
            
            detectLocationFromCoords(lat, lng);
        }

        async function detectLocationFromCoords(lat, lng) {
            console.log('üîç Hled√°m adresu pro:', lat, lng);
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                const data = await response.json();
                
                if (data && data.display_name) {
                    const address = data.address || {};
                    let location = '';
                    
                    if (address.house_number && address.road) {
                        location = `${address.road} ${address.house_number}`;
                    } else if (address.road) {
                        location = address.road;
                    } else {
                        location = data.display_name.split(',')[0];
                    }
                    
                    const city = address.village || address.town || address.city;
                    if (city && !location.includes(city)) {
                        location += `, ${city}`;
                    }
                    
                    document.getElementById('startLocation').value = location;
                    console.log('‚úÖ Adresa nalezena:', location);
                } else {
                    throw new Error('Adresa nenalezena');
                }
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi hled√°n√≠ adresy:', error);
                document.getElementById('startLocation').value = `GPS: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        }

        function startTrip(e) {
            e.preventDefault();
            
            if (!currentPosition) {
                alert('‚ùå GPS pozice nen√≠ dostupn√°. Poƒçkejte na naƒçten√≠ GPS p≈ôed zah√°jen√≠m.');
                return;
            }

            // Z√≠sk√°n√≠ dat z formul√°≈ôe
            const formData = new FormData(e.target);
            const tripData = Object.fromEntries(formData);
            tripData.tripNumber = document.getElementById('tripNumber').value;
            
            console.log('üöÄ Zahajuji stazku:', tripData);
            
            // Spu≈°tƒõn√≠ sledov√°n√≠
            isTracking = true;
            tripStartTime = new Date();
            currentRoute = [];
            stops = [];
            
            // P≈ôid√°n√≠ prvn√≠ho bodu
            addRoutePoint(currentPosition);
            
            // Aktualizace UI
            document.getElementById('tripInfo').classList.add('active');
            document.getElementById('tripStartTime').textContent = tripStartTime.toLocaleTimeString();
            
            // Skryt√≠ formul√°≈ôe
            document.querySelector('#newTripScreen .form-section').style.display = 'none';
            
            // Zmƒõna tlaƒç√≠tek
            updateActionButtons('tracking');
            
            alert(`‚úÖ Stazka #${tripData.tripNumber} zah√°jena!\n\nüë§ ${tripData.driverName}\nüöö ${tripData.vehiclePlate}\nüìç GPS sledov√°n√≠ aktivn√≠`);
        }

        function addRoutePoint(position) {
            const point = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                timestamp: new Date(),
                speed: position.coords.speed || 0,
                accuracy: position.coords.accuracy
            };
            
            currentRoute.push(point);
            console.log('üìä P≈ôid√°n GPS bod:', point);
        }

        function updateTripStats() {
            if (!isTracking) return;
            
            // Doba j√≠zdy
            const duration = new Date() - tripStartTime;
            const hours = Math.floor(duration / 3600000);
            const minutes = Math.floor((duration % 3600000) / 60000);
            document.getElementById('tripDuration').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            
            // Vzd√°lenost
            let totalDistance = 0;
            for (let i = 1; i < currentRoute.length; i++) {
                totalDistance += calculateDistance(
                    currentRoute[i-1].lat, currentRoute[i-1].lng,
                    currentRoute[i].lat, currentRoute[i].lng
                );
            }
            document.getElementById('tripDistance').textContent = totalDistance.toFixed(1);
            
            // GPS body
            document.getElementById('gpsPoints').textContent = currentRoute.length;
            
            // Zast√°vky
            document.getElementById('stopsCount').textContent = stops.length;
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function stopTrip() {
            if (!confirm('Opravdu chcete ukonƒçit stazku?')) return;
            
            isTracking = false;
            const endTime = new Date();
            
            // V√Ωpoƒçet celkov√© vzd√°lenosti
            let totalDistance = 0;
            for (let i = 1; i < currentRoute.length; i++) {
                totalDistance += calculateDistance(
                    currentRoute[i-1].lat, currentRoute[i-1].lng,
                    currentRoute[i].lat, currentRoute[i].lng
                );
            }
            
            // Vytvo≈ôen√≠ z√°znamu stazky
            const trip = {
                id: Date.now(),
                tripNumber: document.getElementById('tripNumber').value,
                driverName: document.getElementById('driverName').value,
                vehiclePlate: document.getElementById('vehiclePlate').value,
                vehicleType: document.getElementById('vehicleType').value,
                workDate: document.getElementById('workDate').value,
                startTime: tripStartTime,
                endTime: endTime,
                startLocation: document.getElementById('startLocation').value,
                route: [...currentRoute],
                stops: [...stops],
                totalDistance: totalDistance,
                status: 'completed'
            };
            
            // Ulo≈æen√≠
            savedTrips.unshift(trip);
            saveData();
            
            // Zv√Ω≈°en√≠ ƒç√≠sla stazky
            nextTripNumber++;
            
            console.log('‚úÖ Stazka dokonƒçena:', trip);
            
            alert(`‚úÖ Stazka #${trip.tripNumber} dokonƒçena!\n\n‚è±Ô∏è Doba: ${Math.floor((endTime - tripStartTime) / 60000)} minut\nüìè Vzd√°lenost: ${totalDistance.toFixed(1)} km\nüìç GPS bod≈Ø: ${currentRoute.length}`);
            
            // Reset aplikace
            resetApp();
        }

        function addStop() {
            if (!isTracking) return;
            
            const purpose = prompt('√öƒçel zast√°vky:\n1 - Nakl√°dka\n2 - Vykl√°dka\n3 - P≈ôest√°vka\n4 - Jin√©');
            if (!purpose) return;
            
            const purposeMap = {
                '1': 'Nakl√°dka',
                '2': 'Vykl√°dka', 
                '3': 'P≈ôest√°vka',
                '4': 'Jin√©'
            };
            
            const stop = {
                time: new Date(),
                purpose: purposeMap[purpose] || 'Jin√©',
                location: currentPosition ? `${currentPosition.coords.latitude.toFixed(6)}, ${currentPosition.coords.longitude.toFixed(6)}` : 'Nezn√°m√©'
            };
            
            stops.push(stop);
            updateTripStats();
            
            alert(`‚úÖ Zast√°vka p≈ôid√°na!\nüïê ${stop.time.toLocaleTimeString()}\nüìç ${stop.purpose}`);
        }

        function updateActionButtons(mode) {
            const buttons = document.getElementById('actionButtons');
            
            if (mode === 'tracking') {
                buttons.innerHTML = `
                    <button type="button" class="btn btn-secondary" onclick="addStop()">
                        üõë P≈ôidat zast√°vku
                    </button>
                    <button type="button" class="btn btn-danger" onclick="stopTrip()">
                        ‚èπÔ∏è Ukonƒçit stazku
                    </button>
                `;
            } else if (mode === 'saved') {
                buttons.innerHTML = `
                    <button type="button" class="btn btn-secondary" onclick="showNewTrip()">
                        ‚¨ÖÔ∏è Zpƒõt
                    </button>
                    <button type="button" class="btn btn-danger" onclick="clearAllTrips()">
                        üóëÔ∏è Smazat v≈°e
                    </button>
                `;
            } else {
                buttons.innerHTML = `
                    <button type="button" class="btn btn-secondary" onclick="clearForm()">
                        üóëÔ∏è Vymazat
                    </button>
                    <button type="submit" form="tripForm" class="btn">
                        üöÄ Zah√°jit
                    </button>
                `;
            }
        }

        function resetApp() {
            isTracking = false;
            tripStartTime = null;
            currentRoute = [];
            stops = [];
            
            // Obnoven√≠ UI
            document.getElementById('tripInfo').classList.remove('active');
            document.querySelector('#newTripScreen .form-section').style.display = 'block';
            
            updateTripNumber();
            updateActionButtons('default');
            
            console.log('üîÑ Aplikace resetov√°na');
        }

        function toggleMenu() {
            const menu = document.getElementById('dropdownMenu');
            menu.classList.toggle('show');
        }

        function showNewTrip() {
            document.getElementById('newTripScreen').classList.remove('hidden');
            document.getElementById('savedTripsScreen').classList.add('hidden');
            document.getElementById('dropdownMenu').classList.remove('show');
            updateActionButtons('default');
        }

        function showSavedTrips() {
            document.getElementById('newTripScreen').classList.add('hidden');
            document.getElementById('savedTripsScreen').classList.remove('hidden');
            document.getElementById('dropdownMenu').classList.remove('show');
            updateActionButtons('saved');
            displaySavedTrips();
        }

        function displaySavedTrips() {
            const container = document.getElementById('savedTripsList');
            const count = document.getElementById('savedTripsCount');
            
            count.textContent = savedTrips.length;
            
            if (savedTrips.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 15px;">üìÅ</div>
                        <div>≈Ω√°dn√© ulo≈æen√© stazky</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            savedTrips.forEach((trip, index) => {
                const duration = Math.floor((trip.endTime - trip.startTime) / 60000);
                
                const tripElement = document.createElement('div');
                tripElement.className = 'trip-item';
                tripElement.innerHTML = `
                    <div class="trip-title">
                        ‚úÖ Stazka #${trip.tripNumber} - ${trip.driverName}
                    </div>
                    <div class="trip-details">
                        üöö ${trip.vehiclePlate} ‚Ä¢ üìÖ ${new Date(trip.startTime).toLocaleDateString('cs-CZ')} ‚Ä¢ 
                        ‚è±Ô∏è ${duration} min ‚Ä¢ üìè ${trip.totalDistance.toFixed(1)} km ‚Ä¢ üìç ${trip.route.length} GPS bod≈Ø
                    </div>
                    <div class="trip-actions">
                        <button class="btn-small" style="background: #3498db; color: white;" onclick="exportTrip(${index})">
                            üì§ Export
                        </button>
                        <button class="btn-small" style="background: #e74c3c; color: white;" onclick="deleteTrip(${index})">
                            üóëÔ∏è Smazat
                        </button>
                    </div>
                `;
                
                container.appendChild(tripElement);
            });
        }

        function exportTrip(index) {
            const trip = savedTrips[index];
            
            // Vytvo≈ôen√≠ XML
            const xml = generateXML(trip);
            
            // Sta≈æen√≠ souboru
            const blob = new Blob([xml], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `stazka_${trip.tripNumber}_${trip.driverName.replace(/\s+/g, '_')}_${trip.workDate}.xml`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ Stazka #${trip.tripNumber} exportov√°na jako XML soubor!`);
        }

        function generateXML(trip) {
            return `<?xml version="1.0" encoding="UTF-8"?>
<TripReport>
    <TripInfo>
        <TripNumber>${trip.tripNumber}</TripNumber>
        <DriverName>${trip.driverName}</DriverName>
        <VehiclePlate>${trip.vehiclePlate}</VehiclePlate>
        <VehicleType>${trip.vehicleType}</VehicleType>
        <WorkDate>${trip.workDate}</WorkDate>
        <StartTime>${new Date(trip.startTime).toLocaleTimeString('cs-CZ')}</StartTime>
        <EndTime>${new Date(trip.endTime).toLocaleTimeString('cs-CZ')}</EndTime>
        <StartLocation>${trip.startLocation}</StartLocation>
        <TotalDistance>${trip.totalDistance.toFixed(2)}</TotalDistance>
    </TripInfo>
    <Route>
        ${trip.route.map(point => `
        <GPSPoint>
            <Latitude>${point.lat}</Latitude>
            <Longitude>${point.lng}</Longitude>
            <Timestamp>${point.timestamp}</Timestamp>
            <Speed>${(point.speed * 3.6).toFixed(2)}</Speed>
            <Accuracy>${point.accuracy}</Accuracy>
        </GPSPoint>`).join('')}
    </Route>
    <Stops>
        ${trip.stops.map((stop, index) => `
        <Stop>
            <Index>${index + 1}</Index>
            <Time>${stop.time}</Time>
            <Purpose>${stop.purpose}</Purpose>
            <Location>${stop.location}</Location>
        </Stop>`).join('')}
    </Stops>
</TripReport>`;
        }

        function deleteTrip(index) {
            const trip = savedTrips[index];
            
            if (confirm(`Opravdu smazat stazku #${trip.tripNumber}?\n\nüë§ ${trip.driverName}\nüöö ${trip.vehiclePlate}`)) {
                savedTrips.splice(index, 1);
                saveData();
                displaySavedTrips();
                updateMenuCount();
                alert('‚úÖ Stazka smaz√°na!');
            }
        }

        function clearAllTrips() {
            if (confirm('Opravdu smazat v≈°echny ulo≈æen√© stazky?\n\n‚ö†Ô∏è Tato akce je nevratn√°!')) {
                savedTrips = [];
                saveData();
                displaySavedTrips();
                updateMenuCount();
                alert('‚úÖ V≈°echny stazky smaz√°ny!');
            }
        }

        function clearForm() {
            if (confirm('Vymazat formul√°≈ô?')) {
                document.getElementById('tripForm').reset();
                const now = new Date();
                document.getElementById('workDate').valueAsDate = now;
                document.getElementById('startTime').value = now.toTimeString().substr(0,5);
                document.getElementById('startLocation').value = '';
            }
        }

        function clearAllData() {
            if (confirm('Opravdu smazat v≈°echna data aplikace?\n\n‚ö†Ô∏è Sma≈æe se:\n‚Ä¢ V≈°echny ulo≈æen√© stazky\n‚Ä¢ Ulo≈æen√© √∫daje\n‚Ä¢ Nastaven√≠\n\nTato akce je nevratn√°!')) {
                savedTrips = [];
                nextTripNumber = 1;
                
                // Clear local storage simulation
                delete window.stazkaData;
                
                // Reset formul√°≈ôe
                clearForm();
                updateTripNumber();
                updateMenuCount();
                
                // N√°vrat na hlavn√≠ obrazovku
                showNewTrip();
                
                alert('‚úÖ V≈°echna data smaz√°na! Aplikace resetov√°na.');
            }
            
            document.getElementById('dropdownMenu').classList.remove('show');
        }

        function updateTripNumber() {
            document.getElementById('tripNumber').value = String(nextTripNumber).padStart(4, '0');
        }

        function updateMenuCount() {
            const count = savedTrips.length;
            const text = count === 0 ? '0 stazek' : 
                        count === 1 ? '1 stazka' : 
                        count < 5 ? `${count} stazky` : `${count} stazek`;
            document.getElementById('menuTripsCount').textContent = text;
        }

        function loadSavedData() {
            // Simulace localStorage
            const data = window.stazkaData || {};
            savedTrips = data.trips || [];
            nextTripNumber = data.nextNumber || 1;
            
            updateMenuCount();
            console.log('üìÇ Naƒçtena data:', { trips: savedTrips.length, nextNumber: nextTripNumber });
        }

        function saveData() {
            // Simulace localStorage
            window.stazkaData = {
                trips: savedTrips,
                nextNumber: nextTripNumber
            };
            
            updateMenuCount();
            console.log('üíæ Data ulo≈æena:', { trips: savedTrips.length, nextNumber: nextTripNumber });
        }

        // Cleanup p≈ôi zav≈ôen√≠ str√°nky
        window.addEventListener('beforeunload', function() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
        });

        console.log('üì± Stazka Pro naƒçtena - verze 2.0');
    </script>
</body>
</html>
